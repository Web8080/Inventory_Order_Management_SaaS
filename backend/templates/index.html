<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management SaaS</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; }
        .header-left { text-align: left; }
        .header-right { text-align: right; }
        .user-info { display: flex; flex-direction: column; align-items: flex-end; }
        .user-name { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.25rem; }
        .tenant-name { font-size: 0.9rem; opacity: 0.8; }
        .nav { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .nav-buttons { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        .nav-btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; }
        .nav-btn.active { background: #667eea; color: white; }
        .nav-btn:not(.active) { background: #f8f9fa; color: #495057; }
        .nav-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .page { display: none; }
        .page.active { display: block; }
        .card { background: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; text-align: center; }
        .stat-number { font-size: 2.5em; font-weight: bold; margin-bottom: 10px; }
        .stat-label { font-size: 1.1em; opacity: 0.9; }
        .chart-container { position: relative; height: 400px; margin: 20px 0; }
        .table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .table th, .table td { padding: 15px; text-align: left; border-bottom: 1px solid #dee2e6; }
        .table th { background: #f8f9fa; font-weight: 600; }
        .table tr:hover { background: #f8f9fa; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; margin: 5px; transition: all 0.3s ease; }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: #495057; }
        .form-control { width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px; transition: border-color 0.3s ease; }
        .form-control:focus { outline: none; border-color: #667eea; }
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .alert-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 5% auto; padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: black; }
        .ml-insights { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); color: white; padding: 20px; border-radius: 15px; margin: 20px 0; }
        .insight-item { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin: 10px 0; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: 600; }
        .badge-success { background: #28a745; color: white; }
        .badge-warning { background: #ffc107; color: black; }
        .badge-danger { background: #dc3545; color: white; }
        .badge-info { background: #17a2b8; color: white; }
        .integration-item { background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #667eea; }
        .integration-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .settings-section { margin: 30px 0; padding: 20px; background: #f8f9fa; border-radius: 10px; }
        .report-section { margin: 20px 0; }
        .footer { background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 30px 20px; margin-top: 40px; border-radius: 15px; text-align: center; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); }
        .footer-content { max-width: 1200px; margin: 0 auto; }
        .footer-brand { font-size: 1.2em; font-weight: 600; margin-bottom: 10px; }
        .footer-trademark { font-size: 0.9em; opacity: 0.8; margin-bottom: 5px; }
        .footer-company { font-size: 0.85em; opacity: 0.7; }
        .footer-divider { width: 100px; height: 2px; background: linear-gradient(90deg, #667eea, #764ba2); margin: 15px auto; border-radius: 2px; }
        
        /* Trial Banner Styles */
        .trial-banner {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        .trial-banner.trial-warning {
            background: linear-gradient(135deg, #ffc107, #ff9800);
            animation: pulse 2s infinite;
        }
        
        .trial-banner.trial-critical {
            background: linear-gradient(135deg, #dc3545, #c82333);
            animation: shake 1s infinite;
        }
        
        .trial-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .trial-icon {
            font-size: 24px;
        }
        
        .trial-text {
            font-weight: 600;
        }
        
        .trial-upgrade-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .trial-upgrade-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            75% { transform: translateX(3px); }
        }
        
        /* Import Data Page Styles */
        .import-section {
            margin: 30px 0;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 1px solid #e9ecef;
        }
        
        .import-steps {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .step {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .step-content h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .step-content p {
            margin: 0 0 15px 0;
            color: #666;
        }
        
        .template-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .template-buttons .btn {
            font-size: 14px;
            padding: 8px 16px;
        }
        
        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }
        
        .upload-area.dragover {
            border-color: #28a745;
            background: #f0fff4;
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .upload-progress {
            margin: 20px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            text-align: center;
            color: #666;
            font-weight: 500;
        }
        
        .upload-results {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e9ecef;
        }
        
        .import-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .import-type {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }
        
        .import-type h4 {
            color: #667eea;
            margin: 0 0 10px 0;
        }
        
        .import-type p {
            color: #666;
            margin: 0 0 15px 0;
        }
        
        .import-type ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .import-type li {
            color: #666;
            margin: 5px 0;
        }
        
        .help-content {
            text-align: center;
        }
        
        .help-options {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        /* Manual Entry Forms */
        .manual-entry-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .manual-entry-forms {
            margin-top: 30px;
            padding: 25px;
            background: #fff;
            border-radius: 15px;
            border: 2px solid #667eea;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.1);
        }
        
        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f3f4;
        }
        
        .manual-form {
            max-width: 600px;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e1e5e9;
        }
    </style>
  </head>
  <body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <h1>üè≠ Inventory Management SaaS</h1>
                    <p>Advanced AI-Powered Inventory & Order Management Platform</p>
                </div>
                <div class="header-right">
                    <div class="user-info">
                        <span class="user-name" id="userDisplayName">Loading...</span>
                        <span class="tenant-name" id="tenantDisplayName">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="nav">
            <div class="nav-buttons">
                <button class="nav-btn active" onclick="showPage('dashboard', this)">üìä Dashboard</button>
                <button class="nav-btn" onclick="showPage('products', this)">üì¶ Products</button>
                <button class="nav-btn" onclick="showPage('orders', this)">üõí Orders</button>
                <button class="nav-btn" onclick="showPage('inventory', this)">üìà Inventory</button>
                <button class="nav-btn" onclick="showPage('reports', this)">üìã Reports</button>
                <button class="nav-btn" onclick="showPage('integrations', this)">üîó Integrations</button>
                <button class="nav-btn" onclick="showPage('ml', this)">ü§ñ AI Insights</button>
                <button class="nav-btn" onclick="showPage('settings', this)">‚öôÔ∏è Settings</button>
                <button class="nav-btn" onclick="showPage('import', this)">üìä Import Data</button>
                <button class="nav-btn btn-danger" onclick="logout()">üö™ Logout</button>
            </div>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboard" class="page active">
            <!-- Trial Status Banner -->
            <div id="trial-banner" class="trial-banner" style="display: none;">
                <div class="trial-content">
                    <span class="trial-icon">üéâ</span>
                    <span class="trial-text">Free Trial Active - <span id="trial-days">14</span> days remaining</span>
                    <button class="trial-upgrade-btn" onclick="upgradeTrial()">Upgrade Now</button>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card pulse">
                    <div class="stat-number" id="totalProducts">0</div>
                    <div class="stat-label">Total Products</div>
                </div>
                <div class="stat-card pulse">
                    <div class="stat-number" id="totalOrders">0</div>
                    <div class="stat-label">Active Orders</div>
                </div>
                <div class="stat-card pulse">
                    <div class="stat-number" id="totalRevenue">$0</div>
                    <div class="stat-label">Monthly Revenue</div>
                </div>
                <div class="stat-card pulse">
                    <div class="stat-number" id="inventoryValue">$0</div>
                    <div class="stat-label">Inventory Value</div>
                </div>
            </div>

            <div class="card">
                <h2>üìà Sales Analytics</h2>
                <div class="chart-container">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2>üéØ AI-Powered Insights</h2>
                <div class="ml-insights" id="aiInsightsContent">
                    <div class="insight-item">
                        <strong>üìä Status:</strong> No data available yet. Import your business data to enable AI insights.
                    </div>
                    <div class="insight-item">
                        <strong>üöÄ Next Steps:</strong> Use the "Import Data" button to upload your products, inventory, and sales data.
                    </div>
                    <div class="insight-item">
                        <strong>üí° Benefits:</strong> Once you have data, you'll see demand forecasts, stock alerts, and revenue predictions.
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üìä Top Performing Products</h2>
                <div class="chart-container">
                    <canvas id="productsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Products Page -->
        <div id="products" class="page">
            <div class="card">
                <h2>üì¶ Product Management</h2>
                <button class="btn btn-primary" onclick="openModal('addProductModal')">+ Add New Product</button>
                <button class="btn btn-success" onclick="bulkImport()">üì• Bulk Import</button>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th>Product Name</th>
                            <th>Category</th>
                            <th>Price</th>
                            <th>Stock</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="productsTable">
                        <tr><td colspan="7" class="text-center text-muted">Loading products...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Orders Page -->
        <div id="orders" class="page">
            <div class="card">
                <h2>üõí Order Management</h2>
                <button class="btn btn-primary" onclick="createNewOrder()">+ Create New Order</button>
                <button class="btn btn-success" onclick="exportOrders()">üì• Export Orders</button>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="ordersPending">0</div>
                        <div class="stat-label">Pending Orders</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ordersCompletedToday">0</div>
                        <div class="stat-label">Completed Today</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ordersTodayRevenue">$0</div>
                        <div class="stat-label">Today's Revenue</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ordersOverdue">0</div>
                        <div class="stat-label">Overdue Orders</div>
                    </div>
                </div>

                <table class="table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Date</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTable">
                        <tr><td colspan="6" class="text-center text-muted">Loading orders...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Inventory Page -->
        <div id="inventory" class="page">
            <div class="card">
                <h2>üìà Inventory Management</h2>
                <button class="btn btn-primary" onclick="openModal('adjustStockModal')">üìä Adjust Stock</button>
                <button class="btn btn-success" onclick="bulkStockUpdate()">üì• Bulk Update</button>
                <button class="btn btn-warning" onclick="generateStockReport()">üìã Stock Report</button>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="inventoryTotalSKUs">0</div>
                        <div class="stat-label">Total SKUs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);">
                            <div class="stat-number" id="inventoryLowStock">0</div>
                            <div class="stat-label">Low Stock Items</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="inventoryTotalValue">$0</div>
                        <div class="stat-label">Inventory Value</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="inventoryAccuracy">0%</div>
                        <div class="stat-label">Stock Accuracy</div>
                    </div>
                </div>

                <div class="card">
                    <h3>üö® Low Stock Alerts</h3>
                    <div id="lowStockAlerts">
                        <div class="alert alert-info">
                            <strong>No low stock alerts</strong> - All items are well stocked
                        </div>
                    </div>
                </div>

                <table class="table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>SKU</th>
                            <th>Current Stock</th>
                            <th>Reorder Point</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTable">
                        <tr><td colspan="6" class="text-center text-muted">Loading inventory...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Reports Page -->
        <div id="reports" class="page">
            <div class="card">
                <h2>üìã Reports & Analytics</h2>
                <div class="nav-buttons">
                    <button class="nav-btn active" onclick="showReport('sales', this)">üìä Sales Report</button>
                    <button class="nav-btn" onclick="showReport('inventory', this)">üì¶ Inventory Report</button>
                    <button class="nav-btn" onclick="showReport('performance', this)">üìà Performance Report</button>
                    <button class="nav-btn" onclick="showReport('financial', this)">üí∞ Financial Report</button>
                </div>

                <div id="salesReport" class="report-section">
                    <h3>üìä Sales Analytics</h3>
                    <div class="chart-container">
                        <canvas id="salesReportChart"></canvas>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="reportsTotalSales">$0</div>
                            <div class="stat-label">Total Sales</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="reportsOrdersProcessed">0</div>
                            <div class="stat-label">Orders Processed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="reportsAvgOrderValue">$0</div>
                            <div class="stat-label">Average Order Value</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="reportsGrowthRate">0%</div>
                            <div class="stat-label">Growth Rate</div>
                        </div>
                    </div>
                </div>

                <div id="inventoryReport" class="report-section" style="display: none;">
                    <h3>üì¶ Inventory Analysis</h3>
                    <div class="chart-container">
                        <canvas id="inventoryReportChart"></canvas>
                    </div>
                    <div class="alert alert-info">
                        <strong>Inventory Turnover:</strong> <span id="inventoryTurnover">0x</span> per year (Industry average: 3.5x)
                    </div>
                    <div class="alert alert-success">
                        <strong>Stock Accuracy:</strong> <span id="stockAccuracy">0%</span> (Target: 95%)
                    </div>
                </div>
            </div>
        </div>

        <!-- Integrations Page -->
        <div id="integrations" class="page">
            <div class="card">
                <h2>üîó Third-Party Integrations</h2>
                <p>Connect your inventory system with popular e-commerce platforms and services.</p>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">3</div>
                        <div class="stat-label">Active Integrations</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">1,245</div>
                        <div class="stat-label">Products Synced</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">89</div>
                        <div class="stat-label">Orders Imported</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">99.2%</div>
                        <div class="stat-label">Sync Success Rate</div>
                    </div>
                </div>

                <div class="card">
                    <h3>üõçÔ∏è E-commerce Platforms</h3>
                    <div class="integration-item">
                        <div class="integration-header">
                            <h4>üõí Shopify</h4>
                            <span class="badge badge-success">Connected</span>
                        </div>
                        <p>Last sync: 2 minutes ago | Products: 456 | Orders: 23</p>
                        <button class="btn btn-primary" onclick="configureShopify()">Configure</button>
                        <button class="btn btn-warning" onclick="syncShopify()">Sync Now</button>
                    </div>

                    <div class="integration-item">
                        <div class="integration-header">
                            <h4>üõçÔ∏è WooCommerce</h4>
                            <span class="badge badge-warning">Pending Setup</span>
                        </div>
                        <p>Connect your WooCommerce store to sync products and orders</p>
                        <button class="btn btn-primary" onclick="connectWooCommerce()">Connect</button>
                    </div>

                    <div class="integration-item">
                        <div class="integration-header">
                            <h4>üì¶ Amazon</h4>
                            <span class="badge badge-success">Connected</span>
                        </div>
                        <p>Last sync: 5 minutes ago | Products: 234 | Orders: 12</p>
                        <button class="btn btn-primary" onclick="configureAmazon()">Configure</button>
                        <button class="btn btn-warning" onclick="syncAmazon()">Sync Now</button>
                    </div>
                </div>

                <div class="card">
                    <h3>üíº Business Tools</h3>
                    <div class="integration-item">
                        <div class="integration-header">
                            <h4>üí∞ QuickBooks</h4>
                            <span class="badge badge-warning">Pending Setup</span>
                        </div>
                        <p>Sync financial data and generate invoices automatically</p>
                        <button class="btn btn-primary" onclick="connectQuickBooks()">Connect</button>
                    </div>

                    <div class="integration-item">
                        <div class="integration-header">
                            <h4>üìß Mailchimp</h4>
                            <span class="badge badge-success">Connected</span>
                        </div>
                        <p>Last sync: 1 hour ago | Subscribers: 1,234</p>
                        <button class="btn btn-primary" onclick="configureMailchimp()">Configure</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Insights Page -->
        <div id="ml" class="page">
            <div class="card">
                <h2>ü§ñ AI-Powered Insights</h2>
                <p>Leverage machine learning to optimize your inventory and predict future trends.</p>

                <!-- AI Model Status -->
                <div class="ml-insights" id="aiStatus">
                    <h3>üß† AI Model Status</h3>
                    <div class="insight-item">
                        <strong>Models Loaded:</strong> <span id="modelsLoaded">Loading...</span>
                    </div>
                    <div class="insight-item">
                        <strong>Forecasting Models:</strong> <span id="forecastingModels">Loading...</span>
                    </div>
                    <div class="insight-item">
                        <strong>Products Optimized:</strong> <span id="productsOptimized">Loading...</span>
                    </div>
                    <div class="insight-item">
                        <strong>Model Accuracy:</strong> <span id="modelAccuracy">Loading...</span>
                    </div>
                </div>

                <!-- Demand Prediction Section -->
                <div class="card">
                    <h3>üìà Demand Prediction</h3>
                    <div class="form-group">
                        <label class="form-label">Select Product for Prediction:</label>
                        <select class="form-control" id="productSelect">
                            <option value="">Loading products...</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="predictDemand()">üîÆ Predict Demand</button>
                    <div id="predictionResult" style="margin-top: 20px;"></div>
                </div>

                <!-- Optimization Recommendations -->
                <div class="card">
                    <h3>üéØ Optimization Recommendations</h3>
                    <div class="form-group">
                        <label class="form-label">Select Product for Optimization:</label>
                        <select class="form-control" id="optimizationProductSelect">
                            <option value="">Loading products...</option>
                        </select>
                    </div>
                    <button class="btn btn-success" onclick="getOptimizationRecommendations()">‚ö° Get Recommendations</button>
                    <div id="optimizationResult" style="margin-top: 20px;"></div>
                </div>

                <!-- Performance Metrics -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="predictionAccuracy">--</div>
                        <div class="stat-label">Prediction Accuracy</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="costSavings">--</div>
                        <div class="stat-label">Cost Savings</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="optimizations">--</div>
                        <div class="stat-label">Optimizations</div>
                    </div>
                </div>

                <!-- Model Performance Chart -->
                <div class="card">
                    <h3>üìä Model Performance</h3>
                    <div class="chart-container">
                        <canvas id="modelPerformanceChart"></canvas>
                    </div>
                </div>

                <!-- AI Recommendations -->
                <div class="card">
                    <h3>üéØ AI Recommendations</h3>
                    <div class="alert alert-success">
                        <strong>‚úÖ High Priority:</strong> Increase iPhone 15 Pro stock by 30% for February
                    </div>
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è Medium Priority:</strong> Reduce MacBook Pro M3 inventory by 20% for Q2
                    </div>
                    <div class="alert alert-info">
                        <strong>‚ÑπÔ∏è Low Priority:</strong> Consider adding wireless accessories category
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settings" class="page">
            <div class="card">
                <h2>‚öôÔ∏è System Settings</h2>
                
                <div class="settings-section">
                    <h3>üë§ User Profile</h3>
                    <form id="userProfile">
                        <div class="form-group">
                            <label class="form-label">First Name</label>
                            <input type="text" class="form-control" id="userFirstName" name="first_name" placeholder="Loading...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="userLastName" name="last_name" placeholder="Loading...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="userEmail" name="email" placeholder="Loading...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="userPhone" name="phone" placeholder="Optional">
                        </div>
                        <button type="submit" class="btn btn-primary">Update Profile</button>
                    </form>
                </div>
                
                <div class="settings-section">
                    <h3>üîê Security Settings</h3>
                    <form id="passwordChangeForm">
                        <div class="form-group">
                            <label class="form-label">Current Password</label>
                            <input type="password" class="form-control" id="currentPassword" name="current_password" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">New Password</label>
                            <input type="password" class="form-control" id="newPassword" name="new_password" required minlength="8">
                            <small class="form-text">Password must be at least 8 characters long</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirmPassword" name="confirm_password" required>
                        </div>
                        <button type="submit" class="btn btn-warning">Change Password</button>
                    </form>
                </div>

                <div class="settings-section">
                    <h3>üè¢ Company Information</h3>
                    <form id="companySettings">
                        <div class="form-group">
                            <label class="form-label">Company Name</label>
                            <input type="text" class="form-control" id="companyName" name="companyName" placeholder="Loading...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Website</label>
                            <input type="url" class="form-control" id="companyWebsite" name="website" placeholder="https://yourcompany.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Industry</label>
                            <select class="form-control" id="companyIndustry" name="industry">
                                <option value="retail">Retail</option>
                                <option value="manufacturing">Manufacturing</option>
                                <option value="wholesale">Wholesale</option>
                                <option value="ecommerce">E-commerce</option>
                                <option value="technology">Technology</option>
                                <option value="healthcare">Healthcare</option>
                                <option value="automotive">Automotive</option>
                                <option value="food">Food & Beverage</option>
                                <option value="fashion">Fashion</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Company Size</label>
                            <select class="form-control" id="companySize" name="company_size">
                                <option value="1-10">1-10 employees</option>
                                <option value="11-50">11-50 employees</option>
                                <option value="51-200">51-200 employees</option>
                                <option value="201-500">201-500 employees</option>
                                <option value="500+">500+ employees</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </form>
                </div>

                <div class="settings-section">
                    <h3>üìä Inventory Settings</h3>
                    <form id="inventorySettings">
                        <div class="form-group">
                            <label class="form-label">Default Reorder Point</label>
                            <input type="number" class="form-control" value="10" name="reorderPoint">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Low Stock Alert Threshold</label>
                            <input type="number" class="form-control" value="5" name="lowStockThreshold">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Currency</label>
                            <select class="form-control" name="currency">
                                <option value="USD" selected>USD ($)</option>
                                <option value="EUR">EUR (‚Ç¨)</option>
                                <option value="GBP">GBP (¬£)</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </form>
                </div>

                <div class="settings-section">
                    <h3>üîî Notification Settings</h3>
                    <form id="notificationSettings">
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" checked> Email notifications for low stock
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" checked> SMS alerts for critical stock levels
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox"> Daily sales summary emails
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" checked> Weekly inventory reports
                            </label>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </form>
                </div>

                <div class="settings-section">
                    <h3>üë• User Management</h3>
                    <button class="btn btn-primary" onclick="addUser()">+ Add User</button>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            <tr>
                                <td colspan="5" class="text-center text-muted">Loading users...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Add Product Modal -->
        <div id="addProductModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('addProductModal')">&times;</span>
                <h2>Add New Product</h2>
                <form id="addProductForm">
                    <div class="form-group">
                        <label class="form-label">Product Name</label>
                        <input type="text" class="form-control" name="name" placeholder="e.g., iPhone 15 Pro" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">SKU</label>
                        <input type="text" class="form-control" name="sku" placeholder="e.g., IPH15-128-BLK" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select class="form-control" name="category" required>
                            <option value="">Select Category</option>
                            <option value="Electronics">Electronics</option>
                            <option value="Clothing">Clothing</option>
                            <option value="Home & Garden">Home & Garden</option>
                            <option value="Sports & Outdoors">Sports & Outdoors</option>
                            <option value="Books">Books</option>
                            <option value="Health & Beauty">Health & Beauty</option>
                            <option value="Automotive">Automotive</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Selling Price</label>
                        <input type="number" class="form-control" name="price" step="0.01" placeholder="0.00" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Initial Stock</label>
                        <input type="number" class="form-control" name="stock" placeholder="0" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Brand</label>
                        <input type="text" class="form-control" name="brand" placeholder="e.g., Apple, Samsung">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Supplier</label>
                        <input type="text" class="form-control" name="supplier" placeholder="e.g., Tech Distributors Inc">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Barcode</label>
                        <input type="text" class="form-control" name="barcode" placeholder="e.g., 1234567890123">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="3" placeholder="Enter product description..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Product</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addProductModal')">Cancel</button>
                </form>
            </div>
        </div>


        <!-- Import Data Page -->
        <div id="import" class="page">
            <div class="card">
                <h2>üìä Import Your Data</h2>
                <p class="text-muted">Upload your existing business data to get started with InventoryFlow</p>
                
                <div class="import-section">
                    <h3>üöÄ Quick Start Guide</h3>
                    <div class="import-steps">
                        <div class="step">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <h4>Download Templates</h4>
                                <p>Get CSV templates for your data</p>
                                <div class="template-buttons">
                                    <button class="btn btn-outline" onclick="downloadTemplate('products')">üì¶ Products Template</button>
                                    <button class="btn btn-outline" onclick="downloadTemplate('inventory')">üìà Inventory Template</button>
                                    <button class="btn btn-outline" onclick="downloadTemplate('customers')">üë• Customers Template</button>
                                    <button class="btn btn-outline" onclick="downloadTemplate('suppliers')">üè≠ Suppliers Template</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <h4>Prepare Your Data</h4>
                                <p>Fill in your data using the templates</p>
                                <ul>
                                    <li>‚úÖ Use the exact column headers from templates</li>
                                    <li>‚úÖ Ensure data is in the correct format</li>
                                    <li>‚úÖ Remove any empty rows</li>
                                    <li>‚úÖ Save as CSV format</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="step">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <h4>Upload Your Files</h4>
                                <p>Upload your prepared CSV files</p>
                                <div class="upload-area" id="uploadArea">
                                    <div class="upload-content">
                                        <div class="upload-icon">üìÅ</div>
                                        <h4>Drag & Drop CSV files here</h4>
                                        <p>or click to browse</p>
                                        <input type="file" id="csvFile" accept=".csv" multiple style="display: none;">
                                        <button class="btn btn-primary" onclick="document.getElementById('csvFile').click()">Choose Files</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="import-section">
                    <h3>üìã Upload Progress</h3>
                    <div id="uploadProgress" class="upload-progress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="progress-text" id="progressText">Uploading...</div>
                    </div>
                    
                    <div id="uploadResults" class="upload-results" style="display: none;">
                        <h4>Upload Results</h4>
                        <div id="resultsContent"></div>
                    </div>
                </div>

                <div class="import-section">
                    <h3>üìù Manual Data Entry</h3>
                    <p>Prefer to enter data manually? Use our quick entry forms:</p>
                    <div class="manual-entry-buttons">
                        <button class="btn btn-outline" onclick="showManualEntry('products')">Add Products</button>
                        <button class="btn btn-outline" onclick="showManualEntry('inventory')">Add Inventory</button>
                        <button class="btn btn-outline" onclick="showManualEntry('customers')">Add Customers</button>
                        <button class="btn btn-outline" onclick="showManualEntry('suppliers')">Add Suppliers</button>
                    </div>
                </div>
                
                <!-- Manual Entry Forms -->
                <div id="manualEntryForms" class="manual-entry-forms" style="display: none;">
                    <div class="form-header">
                        <h3 id="manualEntryTitle">Manual Entry</h3>
                        <button class="btn btn-sm btn-outline" onclick="hideManualEntry()">Close</button>
                    </div>
                    
                    <!-- Products Form -->
                    <div id="productsForm" class="manual-form" style="display: none;">
                        <form id="manualProductForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="productSku">SKU *</label>
                                    <input type="text" id="productSku" name="sku" placeholder="e.g., IPH15-128-BLK" required>
                                </div>
                                <div class="form-group">
                                    <label for="productName">Product Name *</label>
                                    <input type="text" id="productName" name="name" placeholder="e.g., iPhone 15 Pro" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="productDescription">Description</label>
                                <textarea id="productDescription" name="description" rows="3" placeholder="Enter product description..."></textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="productCategory">Category</label>
                                    <input type="text" id="productCategory" name="category" placeholder="e.g., Electronics">
                                </div>
                                <div class="form-group">
                                    <label for="productBrand">Brand</label>
                                    <input type="text" id="productBrand" name="brand" placeholder="e.g., Apple">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="productSellingPrice">Selling Price *</label>
                                    <input type="number" id="productSellingPrice" name="selling_price" step="0.01" placeholder="0.00" required>
                                </div>
                                <div class="form-group">
                                    <label for="productCostPrice">Cost Price *</label>
                                    <input type="number" id="productCostPrice" name="cost_price" step="0.01" placeholder="0.00" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="productBarcode">Barcode</label>
                                <input type="text" id="productBarcode" name="barcode" placeholder="e.g., 1234567890123">
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">Add Product</button>
                                <button type="button" class="btn btn-outline" onclick="hideManualEntry()">Cancel</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Inventory Form -->
                    <div id="inventoryForm" class="manual-form" style="display: none;">
                        <form id="addInventoryForm">
                            <div class="form-group">
                                <label for="inventoryProduct">Product *</label>
                                <select id="inventoryProduct" name="product_sku" required>
                                    <option value="">Select a product...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="inventoryWarehouse">Warehouse *</label>
                                <select id="inventoryWarehouse" name="warehouse" required>
                                    <option value="Main Warehouse">Main Warehouse</option>
                                </select>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="inventoryQuantity">Quantity *</label>
                                    <input type="number" id="inventoryQuantity" name="quantity" required>
                                </div>
                                <div class="form-group">
                                    <label for="inventoryReorderPoint">Reorder Point</label>
                                    <input type="number" id="inventoryReorderPoint" name="reorder_point" value="10">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="inventoryLocation">Location</label>
                                <input type="text" id="inventoryLocation" name="location" placeholder="e.g., Aisle 1, Shelf 3">
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">Add Inventory</button>
                                <button type="button" class="btn btn-outline" onclick="hideManualEntry()">Cancel</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Customers Form -->
                    <div id="customersForm" class="manual-form" style="display: none;">
                        <form id="addCustomerForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="customerFirstName">First Name *</label>
                                    <input type="text" id="customerFirstName" name="first_name" required>
                                </div>
                                <div class="form-group">
                                    <label for="customerLastName">Last Name *</label>
                                    <input type="text" id="customerLastName" name="last_name" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="customerEmail">Email *</label>
                                <input type="email" id="customerEmail" name="email" required>
                            </div>
                            <div class="form-group">
                                <label for="customerPhone">Phone</label>
                                <input type="tel" id="customerPhone" name="phone">
                            </div>
                            <div class="form-group">
                                <label for="customerAddress">Address</label>
                                <textarea id="customerAddress" name="address" rows="3"></textarea>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">Add Customer</button>
                                <button type="button" class="btn btn-outline" onclick="hideManualEntry()">Cancel</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Suppliers Form -->
                    <div id="suppliersForm" class="manual-form" style="display: none;">
                        <form id="addSupplierForm">
                            <div class="form-group">
                                <label for="supplierName">Company Name *</label>
                                <input type="text" id="supplierName" name="name" required>
                            </div>
                            <div class="form-group">
                                <label for="supplierContact">Contact Person *</label>
                                <input type="text" id="supplierContact" name="contact_person" required>
                            </div>
                            <div class="form-group">
                                <label for="supplierEmail">Email *</label>
                                <input type="email" id="supplierEmail" name="email" required>
                            </div>
                            <div class="form-group">
                                <label for="supplierPhone">Phone</label>
                                <input type="tel" id="supplierPhone" name="phone">
                            </div>
                            <div class="form-group">
                                <label for="supplierAddress">Address</label>
                                <textarea id="supplierAddress" name="address" rows="3"></textarea>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">Add Supplier</button>
                                <button type="button" class="btn btn-outline" onclick="hideManualEntry()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="import-section">
                    <h3>üí° What You Can Import</h3>
                    <div class="import-types">
                        <div class="import-type">
                            <h4>üì¶ Products</h4>
                            <p>Product catalog with variants, pricing, and categories</p>
                            <ul>
                                <li>Product name, SKU, description</li>
                                <li>Pricing (cost and selling price)</li>
                                <li>Categories and suppliers</li>
                                <li>Barcodes and specifications</li>
                            </ul>
                        </div>
                        
                        <div class="import-type">
                            <h4>üìà Inventory</h4>
                            <p>Current stock levels and warehouse information</p>
                            <ul>
                                <li>Stock quantities by warehouse</li>
                                <li>Reorder points and safety stock</li>
                                <li>Warehouse locations</li>
                                <li>Stock status and conditions</li>
                            </ul>
                        </div>
                        
                        <div class="import-type">
                            <h4>üë• Customers</h4>
                            <p>Customer database and contact information</p>
                            <ul>
                                <li>Customer names and contact details</li>
                                <li>Addresses and shipping preferences</li>
                                <li>Customer categories and tags</li>
                                <li>Credit terms and payment methods</li>
                            </ul>
                        </div>
                        
                        <div class="import-type">
                            <h4>üè≠ Suppliers</h4>
                            <p>Supplier and vendor information</p>
                            <ul>
                                <li>Supplier names and contact details</li>
                                <li>Product catalogs and pricing</li>
                                <li>Lead times and terms</li>
                                <li>Quality ratings and notes</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="import-section">
                    <h3>üÜò Need Help?</h3>
                    <div class="help-content">
                        <p>Having trouble with your import? We're here to help!</p>
                        <div class="help-options">
                            <button class="btn btn-outline" onclick="showHelp('format')">üìù Data Format Help</button>
                            <button class="btn btn-outline" onclick="showHelp('troubleshooting')">üîß Troubleshooting</button>
                            <button class="btn btn-outline" onclick="showHelp('contact')">üìû Contact Support</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <div class="footer">
        <div class="footer-content">
            <div class="footer-brand">üè≠ Inventory Management SaaS</div>
            <div class="footer-divider"></div>
                <div class="footer-trademark">Built with love by Victor Ibhafidon</div>
            <div class="footer-company">for XTAINLESS TECHNOLOGIES‚Ñ¢</div>
        </div>
    </div>

    <script>
        // Backend API base URL - using relative URLs to avoid CORS issues
        const API_BASE_URL = '';
        
        // Chart instances storage for cleanup
        let chartInstances = {};
        
        // Function to destroy existing charts
        function destroyChart(chartId) {
            if (chartInstances[chartId]) {
                chartInstances[chartId].destroy();
                delete chartInstances[chartId];
            }
        }
        
        // Function to destroy all charts
        function destroyAllCharts() {
            Object.keys(chartInstances).forEach(chartId => {
                destroyChart(chartId);
            });
        }
        
        // Data Management System
        class DataManager {
            constructor() {
                this.initializeData();
            }

            initializeData() {
                // Initialize default data if not exists
                if (!localStorage.getItem('inventoryData')) {
                    const defaultData = {
                        products: [
                            { id: 1, sku: 'IPH15-128-BLK', name: 'iPhone 15 Pro', category: 'Electronics', price: 999.99, stock: 25, reorderPoint: 10, description: 'Latest iPhone with Pro features' },
                            { id: 2, sku: 'SGS24-256-BLU', name: 'Samsung Galaxy S24', category: 'Electronics', price: 799.99, stock: 15, reorderPoint: 20, description: 'Premium Android smartphone' },
                            { id: 3, sku: 'MBP-M3-512-SLV', name: 'MacBook Pro M3', category: 'Electronics', price: 1999.99, stock: 8, reorderPoint: 10, description: 'Professional laptop with M3 chip' }
                        ],
                        orders: [
                            { id: 'ORD-2024-001', customer: 'John Smith', date: '2024-01-15', total: 299.99, status: 'Completed', items: [{ product: 'iPhone 15 Pro', quantity: 1, price: 299.99 }] },
                            { id: 'ORD-2024-002', customer: 'Sarah Johnson', date: '2024-01-15', total: 1199.99, status: 'Processing', items: [{ product: 'MacBook Pro M3', quantity: 1, price: 1199.99 }] },
                            { id: 'ORD-2024-003', customer: 'Mike Davis', date: '2024-01-14', total: 89.99, status: 'Pending', items: [{ product: 'Samsung Galaxy S24', quantity: 1, price: 89.99 }] }
                        ],
                        users: [
                            { id: 1, name: 'John Admin', email: 'admin@democompany.com', role: 'Owner', status: 'Active' },
                            { id: 2, name: 'Sarah Manager', email: 'manager@democompany.com', role: 'Manager', status: 'Active' }
                        ],
                        settings: {
                            companyName: 'Demo Company',
                            email: 'admin@democompany.com',
                            phone: '+1 (555) 123-4567',
                            reorderPoint: 10,
                            lowStockThreshold: 5,
                            currency: 'USD'
                        }
                    };
                    localStorage.setItem('inventoryData', JSON.stringify(defaultData));
                }
            }

            getData() {
                return JSON.parse(localStorage.getItem('inventoryData'));
            }

            saveData(data) {
                localStorage.setItem('inventoryData', JSON.stringify(data));
            }

            addProduct(product) {
                const data = this.getData();
                product.id = Date.now();
                data.products.push(product);
                this.saveData(data);
                return product;
            }

            updateProduct(id, updates) {
                const data = this.getData();
                const index = data.products.findIndex(p => p.id === id);
                if (index !== -1) {
                    data.products[index] = { ...data.products[index], ...updates };
                    this.saveData(data);
                    return data.products[index];
                }
                return null;
            }

            deleteProduct(id) {
                const data = this.getData();
                data.products = data.products.filter(p => p.id !== id);
                this.saveData(data);
            }

            addOrder(order) {
                const data = this.getData();
                order.id = 'ORD-' + Date.now();
                data.orders.push(order);
                this.saveData(data);
                return order;
            }

            updateOrder(id, updates) {
                const data = this.getData();
                const index = data.orders.findIndex(o => o.id === id);
                if (index !== -1) {
                    data.orders[index] = { ...data.orders[index], ...updates };
                    this.saveData(data);
                    return data.orders[index];
                }
                return null;
            }

            addUser(user) {
                const data = this.getData();
                user.id = Date.now();
                data.users.push(user);
                this.saveData(data);
                return user;
            }

            updateUser(id, updates) {
                const data = this.getData();
                const index = data.users.findIndex(u => u.id === id);
                if (index !== -1) {
                    data.users[index] = { ...data.users[index], ...updates };
                    this.saveData(data);
                    return data.users[index];
                }
                return null;
            }

            deleteUser(id) {
                const data = this.getData();
                data.users = data.users.filter(u => u.id !== id);
                this.saveData(data);
            }

            updateSettings(settings) {
                const data = this.getData();
                data.settings = { ...data.settings, ...settings };
                this.saveData(data);
            }
        }

        // Initialize data manager
        let dataManager;
        try {
            dataManager = new DataManager();
            console.log('DataManager initialized successfully');
        } catch (error) {
            console.error('Error initializing DataManager:', error);
            // Create a fallback data manager
            dataManager = {
                getData: () => ({ products: [], orders: [], users: [], settings: {} }),
                updateSettings: () => {},
                addProduct: () => {},
                addOrder: () => {},
                addUser: () => {}
            };
        }

        // Navigation
        function showPage(pageId, element) {
            console.log('showPage called with:', pageId, element);
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if (element) {
                element.classList.add('active');
            }
            
            // Load page-specific content
            if (pageId === 'dashboard') {
                loadDashboardCharts();
                loadTrialStatus();
            } else if (pageId === 'products') {
                loadProductsTable();
            } else if (pageId === 'orders') {
                loadOrdersTable();
            } else if (pageId === 'inventory') {
                loadInventoryTable();
            } else if (pageId === 'settings') {
                loadTenantSettings();
            } else if (pageId === 'ml') {
                loadAIInsights();
            } else if (pageId === 'import') {
                // Import page is ready, no additional loading needed
            }
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Dashboard Charts
        async function loadDashboardCharts() {
            try {
                console.log('Loading dashboard data...');
                const response = await fetch(`${API_BASE_URL}/tenants/dashboard/data/`, {
                    credentials: 'include'
                });
                console.log('Dashboard response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Dashboard data received:', result);
                
                if (result.success) {
                    const data = result.data;
                    
                    // Update metrics
                    document.getElementById('totalProducts').textContent = data.metrics.total_products;
                    document.getElementById('totalOrders').textContent = data.metrics.total_orders;
                    document.getElementById('totalRevenue').textContent = '$' + data.metrics.revenue_30_days.toLocaleString();
                    document.getElementById('inventoryValue').textContent = '$' + data.metrics.total_inventory_value.toLocaleString();
                    
                    // Sales Chart
                    destroyChart('salesChart');
                    const salesCtx = document.getElementById('salesChart').getContext('2d');
                    chartInstances['salesChart'] = new Chart(salesCtx, {
                        type: 'line',
                        data: {
                            labels: data.sales_chart.labels.map(date => new Date(date).toLocaleDateString()),
                            datasets: [{
                                label: 'Sales Revenue',
                                data: data.sales_chart.data,
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return '$' + value.toLocaleString();
                                        }
                                    }
                                }
                            }
                        }
                    });
                    
                    // Update recent orders
                    updateRecentOrders(data.recent_orders);
                    
                    // Update low stock items
                    updateLowStockItems(data.low_stock_items);
                    
                    // Update top products
                    updateTopProducts(data.top_products);
                    
                    // Update AI insights with real data
                    updateAIInsights(data);
                    
                } else {
                    // Show empty state for new users
                    showEmptyDashboard();
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showEmptyDashboard();
            }
        }
        
        function showEmptyDashboard() {
            // Update metrics to show 0 for new users
            document.getElementById('totalProducts').textContent = '0';
            document.getElementById('totalOrders').textContent = '0';
            document.getElementById('totalRevenue').textContent = '$0';
            document.getElementById('inventoryValue').textContent = '$0';
            
            // Show empty sales chart
            destroyChart('salesChart');
            const salesCtx = document.getElementById('salesChart').getContext('2d');
            chartInstances['salesChart'] = new Chart(salesCtx, {
                type: 'line',
                data: {
                    labels: ['No data yet'],
                    datasets: [{
                        label: 'Sales Revenue',
                        data: [0],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
            
            // Show empty state messages
            updateRecentOrders([]);
            updateLowStockItems([]);
            updateTopProducts([]);
            
            // Update AI insights to show empty state
            updateAIInsights({ metrics: { total_products: 0, revenue_30_days: 0 }, low_stock_items: [] });
        }
        
        function updateRecentOrders(orders) {
            const tbody = document.querySelector('#recentOrdersTable tbody');
            if (!tbody) {
                console.warn('Recent orders table not found');
                return;
            }
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No orders yet. Start by importing your data or creating your first order.</td></tr>';
            } else {
                tbody.innerHTML = orders.map(order => `
                    <tr>
                        <td>${order.order_number}</td>
                        <td>${order.customer_name}</td>
                        <td>$${order.total.toLocaleString()}</td>
                        <td><span class="status status-${order.status}">${order.status}</span></td>
                    </tr>
                `).join('');
            }
        }
        
        function updateLowStockItems(items) {
            const tbody = document.querySelector('#lowStockTable tbody');
            if (items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No low stock items. Import your inventory data to see stock levels.</td></tr>';
            } else {
                tbody.innerHTML = items.map(item => `
                    <tr>
                        <td>${item.product_name}</td>
                        <td>${item.sku}</td>
                        <td><span class="badge badge-warning">${item.quantity} units</span></td>
                    </tr>
                `).join('');
            }
        }
        
        function updateTopProducts(products) {
            const tbody = document.querySelector('#topProductsTable tbody');
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No sales data yet. Import your orders to see top products.</td></tr>';
            } else {
                tbody.innerHTML = products.map(product => `
                    <tr>
                        <td>${product.name}</td>
                        <td>${product.quantity}</td>
                        <td>$${product.sales.toLocaleString()}</td>
                    </tr>
                `).join('');
            }
        }
        
        function updateAIInsights(data) {
            const aiInsightsContent = document.getElementById('aiInsightsContent');
            
            if (data.metrics.total_products > 0) {
                // User has data, show real AI insights
                aiInsightsContent.innerHTML = `
                    <div class="insight-item">
                        <strong>üîÆ Demand Forecast:</strong> Based on your ${data.metrics.total_products} products, demand patterns are being analyzed.
                    </div>
                    <div class="insight-item">
                        <strong>‚ö†Ô∏è Stock Alert:</strong> ${data.low_stock_items.length} items need attention for restocking.
                    </div>
                    <div class="insight-item">
                        <strong>üí∞ Revenue Prediction:</strong> Current month revenue: $${data.metrics.revenue_30_days.toLocaleString()}.
                    </div>
                `;
            } else {
                // No data, show empty state
                aiInsightsContent.innerHTML = `
                    <div class="insight-item">
                        <strong>üìä Status:</strong> No data available yet. Import your business data to enable AI insights.
                    </div>
                    <div class="insight-item">
                        <strong>üöÄ Next Steps:</strong> Use the "Import Data" button to upload your products, inventory, and sales data.
                    </div>
                    <div class="insight-item">
                        <strong>üí° Benefits:</strong> Once you have data, you'll see demand forecasts, stock alerts, and revenue predictions.
                    </div>
                `;
            }
        }

        // Product Management
        async function loadProductsTable() {
            try {
                const response = await fetch(`${API_BASE_URL}/tenants/dashboard/products/`, {
                    credentials: 'include'
                });
                const result = await response.json();
                const tbody = document.getElementById('productsTable');
                
                if (result.success && result.data && result.data.length > 0) {
                    tbody.innerHTML = '';
                    result.data.forEach(product => {
                        const row = document.createElement('tr');
                        const statusClass = product.stock <= (product.reorder_point || 10) ? 'badge-warning' : 'badge-success';
                        const statusText = product.stock <= (product.reorder_point || 10) ? 'Low Stock' : 'In Stock';
                        
                        row.innerHTML = `
                            <td>${product.sku || 'N/A'}</td>
                            <td>${product.name || 'N/A'}</td>
                            <td>${product.category || 'N/A'}</td>
                            <td>$${(product.selling_price || 0).toFixed(2)}</td>
                            <td>${product.stock || 0}</td>
                            <td><span class="badge ${statusClass}">${statusText}</span></td>
                            <td>
                                <button class="btn btn-primary" onclick="editProduct('${product.sku}')">Edit</button>
                                <button class="btn btn-danger" onclick="deleteProduct('${product.sku}')">Delete</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    // No data - show empty state
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No products found. <a href="#" onclick="showPage(\'import\', this)">Import your products</a> to get started.</td></tr>';
                }
            } catch (error) {
                console.error('Error loading products:', error);
                const tbody = document.getElementById('productsTable');
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Error loading products. Please refresh the page.</td></tr>';
            }
        }

        function editProduct(id) {
            const data = dataManager.getData();
            const product = data.products.find(p => p.id === id);
            if (product) {
                // Create edit modal
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.id = 'editProductModal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <span class="close" onclick="closeModal('editProductModal')">&times;</span>
                        <h2>Edit Product</h2>
                        <form id="editProductForm">
                            <input type="hidden" name="id" value="${product.id}">
                            <div class="form-group">
                                <label class="form-label">Product Name</label>
                                <input type="text" class="form-control" name="name" value="${product.name}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">SKU</label>
                                <input type="text" class="form-control" name="sku" value="${product.sku}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Category</label>
                                <select class="form-control" name="category" required>
                                    <option value="Electronics" ${product.category === 'Electronics' ? 'selected' : ''}>Electronics</option>
                                    <option value="Clothing" ${product.category === 'Clothing' ? 'selected' : ''}>Clothing</option>
                                    <option value="Home & Garden" ${product.category === 'Home & Garden' ? 'selected' : ''}>Home & Garden</option>
                                    <option value="Sports & Outdoors" ${product.category === 'Sports & Outdoors' ? 'selected' : ''}>Sports & Outdoors</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Price</label>
                                <input type="number" class="form-control" name="price" value="${product.price}" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Stock</label>
                                <input type="number" class="form-control" name="stock" value="${product.stock}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reorder Point</label>
                                <input type="number" class="form-control" name="reorderPoint" value="${product.reorderPoint}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" name="description" rows="3">${product.description}</textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Update Product</button>
                            <button type="button" class="btn btn-secondary" onclick="closeModal('editProductModal')">Cancel</button>
                        </form>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.style.display = 'block';
                
                document.getElementById('editProductForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    const updates = {
                        name: formData.get('name'),
                        sku: formData.get('sku'),
                        category: formData.get('category'),
                        price: parseFloat(formData.get('price')),
                        stock: parseInt(formData.get('stock')),
                        reorderPoint: parseInt(formData.get('reorderPoint')),
                        description: formData.get('description')
                    };
                    dataManager.updateProduct(id, updates);
                    closeModal('editProductModal');
                    loadProductsTable();
                    showNotification('Product updated successfully!');
                });
            }
        }

        async function deleteProduct(sku) {
            if (confirm('Are you sure you want to delete this product?')) {
                try {
                    // First, get the variant ID from the SKU
                    const response = await fetch(`${API_BASE_URL}/tenants/dashboard/products/`, {
                    credentials: 'include'
                });
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        const variant = result.data.find(p => p.sku === sku);
                        if (variant) {
                            // Delete the variant using the standard products API
                            const deleteResponse = await fetch(`${API_BASE_URL}/products/variants/${variant.id}/`, {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCSRFToken()
                                },
                                credentials: 'include' // Include session cookies for authentication
                            });
                            
                            if (deleteResponse.ok) {
                                showNotification('‚úÖ Product deleted successfully!');
                                loadProductsTable(); // Refresh the table
                            } else {
                                const errorData = await deleteResponse.json();
                                showNotification(`‚ùå Error deleting product: ${errorData.detail || 'Unknown error'}`, 'error');
                            }
                        } else {
                            showNotification('‚ùå Product not found', 'error');
                        }
                    } else {
                        showNotification('‚ùå Error loading products', 'error');
                    }
                } catch (error) {
                    console.error('Error deleting product:', error);
                    showNotification(`‚ùå Network error: ${error.message}`, 'error');
                }
            }
        }

        function bulkImport() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const csv = e.target.result;
                        const lines = csv.split('\n');
                        let imported = 0;
                        
                        for (let i = 1; i < lines.length; i++) {
                            const columns = lines[i].split(',');
                            if (columns.length >= 4) {
                                const product = {
                                    sku: columns[0].trim(),
                                    name: columns[1].trim(),
                                    category: columns[2].trim(),
                                    price: parseFloat(columns[3].trim()) || 0,
                                    stock: parseInt(columns[4].trim()) || 0,
                                    reorderPoint: parseInt(columns[5].trim()) || 10,
                                    description: columns[6] ? columns[6].trim() : ''
                                };
                                dataManager.addProduct(product);
                                imported++;
                            }
                        }
                        showNotification(`Successfully imported ${imported} products!`);
                        loadProductsTable();
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // Form handling for modal product form
        document.getElementById('addProductForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const productData = {
                sku: formData.get('sku'),
                name: formData.get('name'),
                category: formData.get('category'),
                selling_price: parseFloat(formData.get('price')),
                cost_price: parseFloat(formData.get('price')) * 0.6, // Assume 40% margin
                description: formData.get('description'),
                brand: formData.get('brand') || '',
                supplier: formData.get('supplier') || '',
                barcode: formData.get('barcode') || ''
            };
            
            try {
                console.log('Submitting product data:', productData);
                
                // Get CSRF token
                const csrfToken = getCookie('csrftoken');
                console.log('CSRF Token:', csrfToken);
                
                if (!csrfToken) {
                    showNotification('‚ùå CSRF token not found. Please refresh the page and try again.', 'error');
                    return;
                }
                
                const response = await fetch(`${API_BASE_URL}/tenants/import/manual-products/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    credentials: 'include', // Include cookies for authentication
                    body: JSON.stringify(productData)
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    showNotification(`‚ùå Server error (${response.status}): ${errorText}`, 'error');
                    return;
                }
                
                const result = await response.json();
                console.log('Response result:', result);
                
                if (result.success) {
                    closeModal('addProductModal');
                    this.reset();
                    loadProductsTable();
                    showNotification('‚úÖ Product added successfully!');
                } else {
                    showNotification(`‚ùå Error adding product: ${result.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                console.error('Error adding product:', error);
                showNotification(`‚ùå Network error adding product: ${error.message}`, 'error');
            }
        });

        // Order Management Functions
        async function loadOrdersTable() {
            try {
                const response = await fetch(`${API_BASE_URL}/tenants/dashboard/orders/`);
                const result = await response.json();
                const tbody = document.querySelector('#orders .table tbody');
                
                if (tbody) {
                    if (result.success && result.data && result.data.length > 0) {
                        tbody.innerHTML = '';
                        
                        result.data.forEach(order => {
                            const row = document.createElement('tr');
                            const statusClass = order.status === 'completed' ? 'badge-success' : 
                                              order.status === 'processing' ? 'badge-warning' : 'badge-danger';
                            
                            row.innerHTML = `
                                <td>${order.order_number || 'N/A'}</td>
                                <td>${order.customer_name || 'N/A'}</td>
                                <td>${order.order_date || 'N/A'}</td>
                                <td>$${(order.total_amount || 0).toFixed(2)}</td>
                                <td><span class="badge ${statusClass}">${order.status || 'N/A'}</span></td>
                                <td>
                                    <button class="btn btn-primary" onclick="viewOrder('${order.id}')">View</button>
                                    <button class="btn btn-warning" onclick="editOrder('${order.id}')">Edit</button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                        
                        // Update order stats
                        document.getElementById('ordersPending').textContent = result.data.filter(order => order.status === 'pending').length;
                        document.getElementById('ordersCompletedToday').textContent = result.data.filter(order => order.status === 'completed').length;
                        document.getElementById('ordersTodayRevenue').textContent = `$${result.data.reduce((sum, order) => sum + (order.total_amount || 0), 0).toLocaleString()}`;
                        document.getElementById('ordersOverdue').textContent = '0'; // Calculate overdue orders if needed
                    } else {
                        // No data - show empty state
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No orders found. <a href="#" onclick="showPage(\'import\', this)">Import your orders</a> to get started.</td></tr>';
                        
                        // Reset order stats
                        document.getElementById('ordersPending').textContent = '0';
                        document.getElementById('ordersCompletedToday').textContent = '0';
                        document.getElementById('ordersTodayRevenue').textContent = '$0';
                        document.getElementById('ordersOverdue').textContent = '0';
                    }
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                const tbody = document.querySelector('#orders .table tbody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Error loading orders. Please refresh the page.</td></tr>';
                }
            }
        }

        function viewOrder(orderId) {
            const data = dataManager.getData();
            const order = data.orders.find(o => o.id === orderId);
            if (order) {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.id = 'viewOrderModal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <span class="close" onclick="closeModal('viewOrderModal')">&times;</span>
                        <h2>Order Details - ${order.id}</h2>
                        <div class="card">
                            <h3>Customer Information</h3>
                            <p><strong>Customer:</strong> ${order.customer}</p>
                            <p><strong>Date:</strong> ${order.date}</p>
                            <p><strong>Status:</strong> ${order.status}</p>
                            <p><strong>Total:</strong> $${order.total.toFixed(2)}</p>
                        </div>
                        <div class="card">
                            <h3>Order Items</h3>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Quantity</th>
                                        <th>Price</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${order.items.map(item => `
                                        <tr>
                                            <td>${item.product}</td>
                                            <td>${item.quantity}</td>
                                            <td>$${item.price.toFixed(2)}</td>
                                            <td>$${(item.quantity * item.price).toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <button class="btn btn-secondary" onclick="closeModal('viewOrderModal')">Close</button>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.style.display = 'block';
            }
        }

        function editOrder(orderId) {
            const data = dataManager.getData();
            const order = data.orders.find(o => o.id === orderId);
            if (order) {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.id = 'editOrderModal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <span class="close" onclick="closeModal('editOrderModal')">&times;</span>
                        <h2>Edit Order - ${order.id}</h2>
                        <form id="editOrderForm">
                            <input type="hidden" name="id" value="${order.id}">
                            <div class="form-group">
                                <label class="form-label">Customer Name</label>
                                <input type="text" class="form-control" name="customer" value="${order.customer}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Order Date</label>
                                <input type="date" class="form-control" name="date" value="${order.date}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select class="form-control" name="status" required>
                                    <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                    <option value="Processing" ${order.status === 'Processing' ? 'selected' : ''}>Processing</option>
                                    <option value="Completed" ${order.status === 'Completed' ? 'selected' : ''}>Completed</option>
                                    <option value="Cancelled" ${order.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Total Amount</label>
                                <input type="number" class="form-control" name="total" value="${order.total}" step="0.01" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Update Order</button>
                            <button type="button" class="btn btn-secondary" onclick="closeModal('editOrderModal')">Cancel</button>
                        </form>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.style.display = 'block';
                
                document.getElementById('editOrderForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    const updates = {
                        customer: formData.get('customer'),
                        date: formData.get('date'),
                        status: formData.get('status'),
                        total: parseFloat(formData.get('total'))
                    };
                    dataManager.updateOrder(orderId, updates);
                    closeModal('editOrderModal');
                    loadOrdersTable();
                    showNotification('Order updated successfully!');
                });
            }
        }

        function exportOrders() {
            const data = dataManager.getData();
            const csvContent = [
                ['Order ID', 'Customer', 'Date', 'Total', 'Status'],
                ...data.orders.map(order => [
                    order.id,
                    order.customer,
                    order.date,
                    order.total.toFixed(2),
                    order.status
                ])
            ].map(row => row.join(',')).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `orders_export_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            showNotification('Orders exported successfully!');
        }

        // Inventory Management Functions
        async function loadInventoryTable() {
            try {
                const response = await fetch(`${API_BASE_URL}/tenants/dashboard/inventory/`);
                const result = await response.json();
                const tbody = document.querySelector('#inventory .table tbody');
                
                if (tbody) {
                    if (result.success && result.data && result.data.length > 0) {
                        tbody.innerHTML = '';
                        
                        result.data.forEach(item => {
                            const row = document.createElement('tr');
                            const statusClass = item.quantity <= (item.reorder_point || 10) ? 'badge-warning' : 'badge-success';
                            const statusText = item.quantity <= (item.reorder_point || 10) ? 'Low Stock' : 'In Stock';
                            
                            row.innerHTML = `
                                <td>${item.product_name || 'N/A'}</td>
                                <td>${item.product_sku || 'N/A'}</td>
                                <td>${item.quantity || 0}</td>
                                <td>${item.reorder_point || 10}</td>
                                <td><span class="badge ${statusClass}">${statusText}</span></td>
                                <td>
                                    <button class="btn btn-primary" onclick="adjustStock('${item.product_sku}')">Adjust</button>
                                    <button class="btn btn-success" onclick="reorder('${item.product_sku}')">Reorder</button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                    } else {
                        // No data - show empty state
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No inventory items found. <a href="#" onclick="showPage(\'import\', this)">Import your inventory</a> to get started.</td></tr>';
                    }
                }
            } catch (error) {
                console.error('Error loading inventory:', error);
                const tbody = document.querySelector('#inventory .table tbody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Error loading inventory. Please refresh the page.</td></tr>';
                }
            }
        }

        function adjustStock(sku) {
            const data = dataManager.getData();
            const product = data.products.find(p => p.sku === sku);
            if (product) {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.id = 'adjustStockModal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <span class="close" onclick="closeModal('adjustStockModal')">&times;</span>
                        <h2>Adjust Stock - ${product.name}</h2>
                        <form id="adjustStockForm">
                            <input type="hidden" name="sku" value="${product.sku}">
                            <div class="form-group">
                                <label class="form-label">Current Stock: ${product.stock}</label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Adjustment Type</label>
                                <select class="form-control" name="adjustmentType" required>
                                    <option value="add">Add Stock</option>
                                    <option value="subtract">Subtract Stock</option>
                                    <option value="set">Set Stock</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Quantity</label>
                                <input type="number" class="form-control" name="quantity" required min="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reason</label>
                                <select class="form-control" name="reason" required>
                                    <option value="received">Stock Received</option>
                                    <option value="sold">Stock Sold</option>
                                    <option value="damaged">Damaged Goods</option>
                                    <option value="returned">Returned Goods</option>
                                    <option value="adjustment">Manual Adjustment</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control" name="notes" rows="3"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Adjust Stock</button>
                            <button type="button" class="btn btn-secondary" onclick="closeModal('adjustStockModal')">Cancel</button>
                        </form>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.style.display = 'block';
                
                document.getElementById('adjustStockForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    const adjustmentType = formData.get('adjustmentType');
                    const quantity = parseInt(formData.get('quantity'));
                    let newStock = product.stock;
                    
                    if (adjustmentType === 'add') {
                        newStock += quantity;
                    } else if (adjustmentType === 'subtract') {
                        newStock -= quantity;
                    } else if (adjustmentType === 'set') {
                        newStock = quantity;
                    }
                    
                    dataManager.updateProduct(product.id, { stock: newStock });
                    closeModal('adjustStockModal');
                    loadInventoryTable();
                    showNotification(`Stock adjusted successfully! New stock: ${newStock}`);
                });
            }
        }

        function reorder(sku) {
            const data = dataManager.getData();
            const product = data.products.find(p => p.sku === sku);
            if (product) {
                const reorderQuantity = product.reorderPoint * 2;
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.id = 'reorderModal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <span class="close" onclick="closeModal('reorderModal')">&times;</span>
                        <h2>Create Reorder - ${product.name}</h2>
                        <form id="reorderForm">
                            <input type="hidden" name="sku" value="${product.sku}">
                            <div class="form-group">
                                <label class="form-label">Product: ${product.name}</label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Current Stock: ${product.stock}</label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reorder Point: ${product.reorderPoint}</label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Suggested Quantity: ${reorderQuantity}</label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reorder Quantity</label>
                                <input type="number" class="form-control" name="quantity" value="${reorderQuantity}" required min="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Supplier</label>
                                <input type="text" class="form-control" name="supplier" placeholder="Enter supplier name" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Expected Delivery Date</label>
                                <input type="date" class="form-control" name="deliveryDate" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Create Reorder</button>
                            <button type="button" class="btn btn-secondary" onclick="closeModal('reorderModal')">Cancel</button>
                        </form>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.style.display = 'block';
                
                document.getElementById('reorderForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    const reorder = {
                        product: product.name,
                        sku: product.sku,
                        quantity: parseInt(formData.get('quantity')),
                        supplier: formData.get('supplier'),
                        deliveryDate: formData.get('deliveryDate'),
                        status: 'Pending',
                        date: new Date().toISOString().split('T')[0]
                    };
                    
                    // Add to orders as purchase order
                    dataManager.addOrder({
                        customer: formData.get('supplier'),
                        date: new Date().toISOString().split('T')[0],
                        total: product.price * reorder.quantity,
                        status: 'Pending',
                        items: [{
                            product: product.name,
                            quantity: reorder.quantity,
                            price: product.price
                        }]
                    });
                    
                    closeModal('reorderModal');
                    showNotification(`Reorder created successfully for ${reorder.quantity} units!`);
                });
            }
        }

        function bulkStockUpdate() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'bulkStockModal';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="closeModal('bulkStockModal')">&times;</span>
                    <h2>Bulk Stock Update</h2>
                    <p>Upload a CSV file with SKU and new stock quantities.</p>
                    <p><strong>CSV Format:</strong> SKU, New Stock Quantity</p>
                    <form id="bulkStockForm">
                        <div class="form-group">
                            <label class="form-label">Select CSV File</label>
                            <input type="file" class="form-control" name="csvFile" accept=".csv" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Update Stock</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('bulkStockModal')">Cancel</button>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'block';
            
            document.getElementById('bulkStockForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const fileInput = this.querySelector('input[type="file"]');
                const file = fileInput.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const csv = e.target.result;
                        const lines = csv.split('\n');
                        let updated = 0;
                        
                        for (let i = 1; i < lines.length; i++) {
                            const columns = lines[i].split(',');
                            if (columns.length >= 2) {
                                const sku = columns[0].trim();
                                const newStock = parseInt(columns[1].trim());
                                const data = dataManager.getData();
                                const product = data.products.find(p => p.sku === sku);
                                if (product) {
                                    dataManager.updateProduct(product.id, { stock: newStock });
                                    updated++;
                                }
                            }
                        }
                        closeModal('bulkStockModal');
                        loadInventoryTable();
                        showNotification(`Successfully updated ${updated} products!`);
                    };
                    reader.readAsText(file);
                }
            });
        }

        function generateStockReport() {
            const data = dataManager.getData();
            const reportData = data.products.map(product => ({
                'Product Name': product.name,
                'SKU': product.sku,
                'Current Stock': product.stock,
                'Reorder Point': product.reorderPoint,
                'Status': product.stock <= product.reorderPoint ? 'Low Stock' : 'In Stock',
                'Value': (product.stock * product.price).toFixed(2)
            }));
            
            const csvContent = [
                Object.keys(reportData[0]),
                ...reportData.map(row => Object.values(row))
            ].map(row => row.join(',')).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `stock_report_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            showNotification('Stock report generated successfully!');
        }

        // Reports Functions
        function showReport(reportType, element) {
            document.querySelectorAll('.report-section').forEach(section => section.style.display = 'none');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            
            if (reportType === 'sales') {
                document.getElementById('salesReport').style.display = 'block';
                if (element) element.classList.add('active');
                loadSalesReportChart();
            } else if (reportType === 'inventory') {
                document.getElementById('inventoryReport').style.display = 'block';
                if (element) element.classList.add('active');
                loadInventoryReportChart();
            } else {
                alert('Report type: ' + reportType + ' - Coming soon!');
            }
        }

        async function loadSalesReportChart() {
            try {
                const response = await fetch(`${API_BASE_URL}/tenants/dashboard/data/`, {
                    credentials: 'include'
                });
                const result = await response.json();
                destroyChart('salesReportChart');
                const ctx = document.getElementById('salesReportChart').getContext('2d');
                
                if (result.success && result.data && result.data.sales_chart) {
                    chartInstances['salesReportChart'] = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: result.data.sales_chart.labels || ['No Data'],
                            datasets: [{
                                label: 'Sales Revenue',
                                data: result.data.sales_chart.data || [0],
                                backgroundColor: '#667eea'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                    
                    // Update stats
                    document.getElementById('reportsTotalSales').textContent = `$${(result.data.metrics?.revenue_30_days || 0).toLocaleString()}`;
                    document.getElementById('reportsOrdersProcessed').textContent = result.data.metrics?.total_orders || 0;
                    document.getElementById('reportsAvgOrderValue').textContent = `$${((result.data.metrics?.revenue_30_days || 0) / (result.data.metrics?.total_orders || 1)).toFixed(2)}`;
                    document.getElementById('reportsGrowthRate').textContent = '0%'; // Calculate growth rate if needed
                } else {
                    // No data - show empty chart
                    chartInstances['salesReportChart'] = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['No Data Available'],
                            datasets: [{
                                label: 'Sales Revenue',
                                data: [0],
                                backgroundColor: '#e9ecef'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading sales report chart:', error);
            }
        }

        function loadInventoryReportChart() {
            destroyChart('inventoryReportChart');
            const ctx = document.getElementById('inventoryReportChart').getContext('2d');
            chartInstances['inventoryReportChart'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Inventory Value',
                        data: [45000, 42000, 48000, 46000, 50000, 45678],
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // Integration Functions
        function configureShopify() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'shopifyConfigModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <span class="close" onclick="closeModal('shopifyConfigModal')">&times;</span>
                    <h2>üõí Shopify Integration Setup</h2>
                    <div class="card">
                        <h3>Step 1: Get Your Shopify Credentials</h3>
                        <p>To connect your Shopify store, you'll need:</p>
                        <ul>
                            <li>Shopify Store URL (e.g., yourstore.myshopify.com)</li>
                            <li>API Key and Secret from your Shopify Partner Dashboard</li>
                            <li>Webhook URL for real-time sync</li>
                        </ul>
                    </div>
                    <form id="shopifyConfigForm">
                        <div class="form-group">
                            <label class="form-label">Shopify Store URL</label>
                            <input type="text" class="form-control" name="storeUrl" placeholder="yourstore.myshopify.com" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">API Key</label>
                            <input type="text" class="form-control" name="apiKey" placeholder="Your Shopify API Key" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">API Secret</label>
                            <input type="password" class="form-control" name="apiSecret" placeholder="Your Shopify API Secret" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Webhook Secret</label>
                            <input type="password" class="form-control" name="webhookSecret" placeholder="Your Webhook Secret" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sync Settings</label>
                            <div style="display: flex; gap: 20px; margin-top: 10px;">
                                <label><input type="checkbox" name="syncProducts" checked> Sync Products</label>
                                <label><input type="checkbox" name="syncOrders" checked> Sync Orders</label>
                                <label><input type="checkbox" name="syncCustomers"> Sync Customers</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sync Frequency</label>
                            <select class="form-control" name="syncFrequency">
                                <option value="realtime">Real-time (Webhooks)</option>
                                <option value="hourly">Every Hour</option>
                                <option value="daily">Daily</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Connect Shopify Store</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('shopifyConfigModal')">Cancel</button>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'block';
            
            document.getElementById('shopifyConfigForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const config = {
                    storeUrl: formData.get('storeUrl'),
                    apiKey: formData.get('apiKey'),
                    apiSecret: formData.get('apiSecret'),
                    webhookSecret: formData.get('webhookSecret'),
                    syncProducts: formData.get('syncProducts') === 'on',
                    syncOrders: formData.get('syncOrders') === 'on',
                    syncCustomers: formData.get('syncCustomers') === 'on',
                    syncFrequency: formData.get('syncFrequency')
                };
                
                // Simulate API call
                setTimeout(() => {
                    closeModal('shopifyConfigModal');
                    showNotification('Shopify store connected successfully! üéâ');
                    // Update integration status
                    updateIntegrationStatus('shopify', 'connected');
                }, 2000);
            });
        }

        function syncShopify() {
            showNotification('Starting Shopify sync...');
            // Simulate sync process
            setTimeout(() => {
                showNotification('Shopify sync completed! 456 products and 23 orders synced.');
            }, 3000);
        }

        function connectWooCommerce() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'woocommerceConfigModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <span class="close" onclick="closeModal('woocommerceConfigModal')">&times;</span>
                    <h2>üõçÔ∏è WooCommerce Integration Setup</h2>
                    <div class="card">
                        <h3>Step 1: Get Your WooCommerce Credentials</h3>
                        <p>To connect your WooCommerce store, you'll need:</p>
                        <ul>
                            <li>WooCommerce Store URL</li>
                            <li>Consumer Key and Consumer Secret from WooCommerce REST API</li>
                            <li>WordPress Admin access</li>
                        </ul>
                    </div>
                    <form id="woocommerceConfigForm">
                        <div class="form-group">
                            <label class="form-label">WooCommerce Store URL</label>
                            <input type="url" class="form-control" name="storeUrl" placeholder="https://yourstore.com" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Consumer Key</label>
                            <input type="text" class="form-control" name="consumerKey" placeholder="ck_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Consumer Secret</label>
                            <input type="password" class="form-control" name="consumerSecret" placeholder="cs_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">API Version</label>
                            <select class="form-control" name="apiVersion">
                                <option value="wc/v3">WooCommerce API v3</option>
                                <option value="wc/v2">WooCommerce API v2</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sync Settings</label>
                            <div style="display: flex; gap: 20px; margin-top: 10px;">
                                <label><input type="checkbox" name="syncProducts" checked> Sync Products</label>
                                <label><input type="checkbox" name="syncOrders" checked> Sync Orders</label>
                                <label><input type="checkbox" name="syncCategories"> Sync Categories</label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Connect WooCommerce Store</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('woocommerceConfigModal')">Cancel</button>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'block';
            
            document.getElementById('woocommerceConfigForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const config = {
                    storeUrl: formData.get('storeUrl'),
                    consumerKey: formData.get('consumerKey'),
                    consumerSecret: formData.get('consumerSecret'),
                    apiVersion: formData.get('apiVersion'),
                    syncProducts: formData.get('syncProducts') === 'on',
                    syncOrders: formData.get('syncOrders') === 'on',
                    syncCategories: formData.get('syncCategories') === 'on'
                };
                
                setTimeout(() => {
                    closeModal('woocommerceConfigModal');
                    showNotification('WooCommerce store connected successfully! üéâ');
                    updateIntegrationStatus('woocommerce', 'connected');
                }, 2000);
            });
        }

        function configureAmazon() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'amazonConfigModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <span class="close" onclick="closeModal('amazonConfigModal')">&times;</span>
                    <h2>üì¶ Amazon Integration Setup</h2>
                    <div class="card">
                        <h3>Step 1: Amazon Seller Central Setup</h3>
                        <p>To connect your Amazon seller account, you'll need:</p>
                        <ul>
                            <li>Amazon Seller Central account</li>
                            <li>MWS (Marketplace Web Service) credentials</li>
                            <li>SP-API (Selling Partner API) access</li>
                        </ul>
                    </div>
                    <form id="amazonConfigForm">
                        <div class="form-group">
                            <label class="form-label">Amazon Marketplace</label>
                            <select class="form-control" name="marketplace" required>
                                <option value="ATVPDKIKX0DER">Amazon.com (US)</option>
                                <option value="A1PA6795UKMFR9">Amazon.de (Germany)</option>
                                <option value="A1RKKUPIHCS9HS">Amazon.es (Spain)</option>
                                <option value="A13V1IB3VIYZZH">Amazon.fr (France)</option>
                                <option value="A21TJRUUN4KGV">Amazon.in (India)</option>
                                <option value="A1VC38T7YXB528">Amazon.co.jp (Japan)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Seller ID</label>
                            <input type="text" class="form-control" name="sellerId" placeholder="A1XXXXXXXXXXXXX" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">MWS Auth Token</label>
                            <input type="text" class="form-control" name="authToken" placeholder="amzn.mws.xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Access Key ID</label>
                            <input type="text" class="form-control" name="accessKeyId" placeholder="AKIAXXXXXXXXXXXXX" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Secret Access Key</label>
                            <input type="password" class="form-control" name="secretAccessKey" placeholder="Your Secret Access Key" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sync Settings</label>
                            <div style="display: flex; gap: 20px; margin-top: 10px;">
                                <label><input type="checkbox" name="syncInventory" checked> Sync Inventory</label>
                                <label><input type="checkbox" name="syncOrders" checked> Sync Orders</label>
                                <label><input type="checkbox" name="syncProducts"> Sync Product Listings</label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Connect Amazon Account</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('amazonConfigModal')">Cancel</button>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'block';
            
            document.getElementById('amazonConfigForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const config = {
                    marketplace: formData.get('marketplace'),
                    sellerId: formData.get('sellerId'),
                    authToken: formData.get('authToken'),
                    accessKeyId: formData.get('accessKeyId'),
                    secretAccessKey: formData.get('secretAccessKey'),
                    syncInventory: formData.get('syncInventory') === 'on',
                    syncOrders: formData.get('syncOrders') === 'on',
                    syncProducts: formData.get('syncProducts') === 'on'
                };
                
                setTimeout(() => {
                    closeModal('amazonConfigModal');
                    showNotification('Amazon account connected successfully! üéâ');
                    updateIntegrationStatus('amazon', 'connected');
                }, 2000);
            });
        }

        function syncAmazon() {
            showNotification('Starting Amazon sync...');
            setTimeout(() => {
                showNotification('Amazon sync completed! 234 products and 12 orders synced.');
            }, 3000);
        }

        function connectQuickBooks() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'quickbooksConfigModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <span class="close" onclick="closeModal('quickbooksConfigModal')">&times;</span>
                    <h2>üí∞ QuickBooks Integration Setup</h2>
                    <div class="card">
                        <h3>Step 1: QuickBooks Online Setup</h3>
                        <p>To connect your QuickBooks account, you'll need:</p>
                        <ul>
                            <li>QuickBooks Online account</li>
                            <li>Intuit Developer account</li>
                            <li>OAuth 2.0 credentials</li>
                        </ul>
                    </div>
                    <form id="quickbooksConfigForm">
                        <div class="form-group">
                            <label class="form-label">QuickBooks Environment</label>
                            <select class="form-control" name="environment" required>
                                <option value="sandbox">Sandbox (Testing)</option>
                                <option value="production">Production</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Client ID</label>
                            <input type="text" class="form-control" name="clientId" placeholder="Your QuickBooks Client ID" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Client Secret</label>
                            <input type="password" class="form-control" name="clientSecret" placeholder="Your QuickBooks Client Secret" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Redirect URI</label>
                            <input type="url" class="form-control" name="redirectUri" value="http://localhost:8000/api/integrations/quickbooks/callback" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sync Settings</label>
                            <div style="display: flex; gap: 20px; margin-top: 10px;">
                                <label><input type="checkbox" name="syncCustomers" checked> Sync Customers</label>
                                <label><input type="checkbox" name="syncInvoices" checked> Sync Invoices</label>
                                <label><input type="checkbox" name="syncPayments"> Sync Payments</label>
                                <label><input type="checkbox" name="syncItems"> Sync Items</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sync Direction</label>
                            <select class="form-control" name="syncDirection">
                                <option value="bidirectional">Bidirectional (Import & Export)</option>
                                <option value="import">Import Only (QuickBooks ‚Üí Inventory)</option>
                                <option value="export">Export Only (Inventory ‚Üí QuickBooks)</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Connect QuickBooks</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('quickbooksConfigModal')">Cancel</button>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'block';
            
            document.getElementById('quickbooksConfigForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const config = {
                    environment: formData.get('environment'),
                    clientId: formData.get('clientId'),
                    clientSecret: formData.get('clientSecret'),
                    redirectUri: formData.get('redirectUri'),
                    syncCustomers: formData.get('syncCustomers') === 'on',
                    syncInvoices: formData.get('syncInvoices') === 'on',
                    syncPayments: formData.get('syncPayments') === 'on',
                    syncItems: formData.get('syncItems') === 'on',
                    syncDirection: formData.get('syncDirection')
                };
                
                setTimeout(() => {
                    closeModal('quickbooksConfigModal');
                    showNotification('QuickBooks connected successfully! üéâ');
                    updateIntegrationStatus('quickbooks', 'connected');
                }, 2000);
            });
        }

        function configureMailchimp() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'mailchimpConfigModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <span class="close" onclick="closeModal('mailchimpConfigModal')">&times;</span>
                    <h2>üìß Mailchimp Integration Setup</h2>
                    <div class="card">
                        <h3>Step 1: Mailchimp API Setup</h3>
                        <p>To connect your Mailchimp account, you'll need:</p>
                        <ul>
                            <li>Mailchimp account</li>
                            <li>API Key from Mailchimp Account Settings</li>
                            <li>Audience ID for your mailing list</li>
                        </ul>
                    </div>
                    <form id="mailchimpConfigForm">
                        <div class="form-group">
                            <label class="form-label">API Key</label>
                            <input type="password" class="form-control" name="apiKey" placeholder="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx-us1" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Audience ID</label>
                            <input type="text" class="form-control" name="audienceId" placeholder="xxxxxxxxxx" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Server Prefix</label>
                            <input type="text" class="form-control" name="serverPrefix" placeholder="us1" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sync Settings</label>
                            <div style="display: flex; gap: 20px; margin-top: 10px;">
                                <label><input type="checkbox" name="syncCustomers" checked> Sync Customers</label>
                                <label><input type="checkbox" name="syncOrders"> Sync Order Data</label>
                                <label><input type="checkbox" name="createSegments"> Create Customer Segments</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Customer Tags</label>
                            <input type="text" class="form-control" name="customerTags" placeholder="vip, premium, new-customer">
                            <small>Comma-separated tags to apply to synced customers</small>
                        </div>
                        <button type="submit" class="btn btn-primary">Connect Mailchimp</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('mailchimpConfigModal')">Cancel</button>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'block';
            
            document.getElementById('mailchimpConfigForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const config = {
                    apiKey: formData.get('apiKey'),
                    audienceId: formData.get('audienceId'),
                    serverPrefix: formData.get('serverPrefix'),
                    syncCustomers: formData.get('syncCustomers') === 'on',
                    syncOrders: formData.get('syncOrders') === 'on',
                    createSegments: formData.get('createSegments') === 'on',
                    customerTags: formData.get('customerTags')
                };
                
                setTimeout(() => {
                    closeModal('mailchimpConfigModal');
                    showNotification('Mailchimp connected successfully! üéâ');
                    updateIntegrationStatus('mailchimp', 'connected');
                }, 2000);
            });
        }

        function updateIntegrationStatus(integration, status) {
            // Update the integration status in the UI
            const integrationItems = document.querySelectorAll('.integration-item');
            integrationItems.forEach(item => {
                const header = item.querySelector('.integration-header h4');
                if (header && header.textContent.includes(integration.charAt(0).toUpperCase() + integration.slice(1))) {
                    const badge = item.querySelector('.badge');
                    if (badge) {
                        badge.textContent = status === 'connected' ? 'Connected' : 'Pending Setup';
                        badge.className = status === 'connected' ? 'badge badge-success' : 'badge badge-warning';
                    }
                }
            });
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.remove();
            }
        }

        // Settings Functions
        function loadSettings() {
            const data = dataManager.getData();
            const settings = data.settings;
            
            // Load company settings
            document.querySelector('input[name="companyName"]').value = settings.companyName;
            document.querySelector('input[name="email"]').value = settings.email;
            document.querySelector('input[name="phone"]').value = settings.phone;
            
            // Load inventory settings
            document.querySelector('input[name="reorderPoint"]').value = settings.reorderPoint;
            document.querySelector('input[name="lowStockThreshold"]').value = settings.lowStockThreshold;
            document.querySelector('select[name="currency"]').value = settings.currency;
            
            // Load users table
            loadUsersTable();
        }

        async function loadUsersTable() {
            try {
                const response = await fetch(`${API_BASE_URL}/tenants/dashboard/users/`);
                const result = await response.json();
                const tbody = document.getElementById('userTableBody');
                
                if (tbody) {
                    if (result.success && result.data && result.data.length > 0) {
                        tbody.innerHTML = '';
                        
                        result.data.forEach(user => {
                            const row = document.createElement('tr');
                            const statusClass = user.is_active ? 'badge-success' : 'badge-danger';
                            
                            row.innerHTML = `
                                <td>${user.first_name} ${user.last_name}</td>
                                <td>${user.email}</td>
                                <td>${user.role}</td>
                                <td><span class="badge ${statusClass}">${user.is_active ? 'Active' : 'Inactive'}</span></td>
                                <td>
                                    <button class="btn btn-primary" onclick="editUser('${user.email}')">Edit</button>
                                    <button class="btn btn-danger" onclick="deleteUser('${user.email}')">Delete</button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                    } else {
                        // No users found - this shouldn't happen as the current user should be listed
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No users found. This should not happen - you should be listed here.</td></tr>';
                    }
                }
            } catch (error) {
                console.error('Error loading users table:', error);
                const tbody = document.getElementById('userTableBody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Error loading users. Please refresh the page.</td></tr>';
                }
            }
        }

        function editUser(userId) {
            const data = dataManager.getData();
            const user = data.users.find(u => u.id === userId);
            if (user) {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.id = 'editUserModal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <span class="close" onclick="closeModal('editUserModal')">&times;</span>
                        <h2>Edit User</h2>
                        <form id="editUserForm">
                            <input type="hidden" name="id" value="${user.id}">
                            <div class="form-group">
                                <label class="form-label">Name</label>
                                <input type="text" class="form-control" name="name" value="${user.name}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" name="email" value="${user.email}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Role</label>
                                <select class="form-control" name="role" required>
                                    <option value="Owner" ${user.role === 'Owner' ? 'selected' : ''}>Owner</option>
                                    <option value="Manager" ${user.role === 'Manager' ? 'selected' : ''}>Manager</option>
                                    <option value="Clerk" ${user.role === 'Clerk' ? 'selected' : ''}>Clerk</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select class="form-control" name="status" required>
                                    <option value="Active" ${user.status === 'Active' ? 'selected' : ''}>Active</option>
                                    <option value="Inactive" ${user.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Update User</button>
                            <button type="button" class="btn btn-secondary" onclick="closeModal('editUserModal')">Cancel</button>
                        </form>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.style.display = 'block';
                
                document.getElementById('editUserForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    const updates = {
                        name: formData.get('name'),
                        email: formData.get('email'),
                        role: formData.get('role'),
                        status: formData.get('status')
                    };
                    dataManager.updateUser(userId, updates);
                    closeModal('editUserModal');
                    loadUsersTable();
                    showNotification('User updated successfully!');
                });
            }
        }

        function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user?')) {
                dataManager.deleteUser(userId);
                loadUsersTable();
                showNotification('User deleted successfully!');
            }
        }

        // Notification system
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-weight: 500;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Add CSS for notifications
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Test function to verify JavaScript is working
        function testButton() {
            alert('JavaScript is working!');
            console.log('testButton function called successfully');
        }
        
        // Simple test to verify JavaScript is loading
        console.log('JavaScript file loaded successfully');
        
        // Load user information
        async function loadUserInfo() {
            try {
                const response = await fetch(`${API_BASE_URL}/tenants/settings/get/`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const userDisplayName = document.getElementById('userDisplayName');
                    const tenantDisplayName = document.getElementById('tenantDisplayName');
                    
                    // Show company name as primary display
                    if (userDisplayName && data.tenant) {
                        userDisplayName.textContent = data.tenant.name || 'Company';
                    }
                    
                    // Show user name as secondary info
                    if (tenantDisplayName && data.user) {
                        const userName = `${data.user.first_name || ''} ${data.user.last_name || ''}`.trim() || data.user.email || 'User';
                        tenantDisplayName.textContent = `Welcome, ${userName}`;
                    }
                } else {
                    console.error('Settings response not ok:', response.status);
                    // Set fallback values
                    document.getElementById('userDisplayName').textContent = 'Company';
                    document.getElementById('tenantDisplayName').textContent = 'Welcome, User';
                }
            } catch (error) {
                console.error('Error loading user info:', error);
                // Set fallback values
                document.getElementById('userDisplayName').textContent = 'Company';
                document.getElementById('tenantDisplayName').textContent = 'Welcome, User';
            }
        }

        // Consolidated DOMContentLoaded event listener
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing application...');
            console.log('showPage function available:', typeof showPage);
            console.log('testButton function available:', typeof testButton);
            
            
            // Initialize dashboard
            try {
                loadDashboardCharts();
            } catch (error) {
                console.error('Error loading dashboard charts:', error);
            }
            
            // Setup file upload functionality
            try {
                setupFileUpload();
            } catch (error) {
                console.error('Error setting up file upload:', error);
            }
            
            // Load user management data
            try {
                loadUserManagement();
            } catch (error) {
                console.error('Error loading user management:', error);
            }
            
            // Setup manual entry form handlers
            try {
                setupManualEntryForms();
            } catch (error) {
                console.error('Error setting up manual entry forms:', error);
            }
            
            // Company settings form
            const companyForm = document.getElementById('companySettings');
            if (companyForm) {
                companyForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    saveCompanyInfo(formData);
                });
            }
            
            // User profile form
            const userForm = document.getElementById('userProfile');
            if (userForm) {
                userForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    saveUserProfile(formData);
                });
            }
            
            // Password change form
            const passwordChangeForm = document.getElementById('passwordChangeForm');
            if (passwordChangeForm) {
                passwordChangeForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    changePassword();
                });
            }
            
            // Inventory settings form
            const inventoryForm = document.getElementById('inventorySettings');
            if (inventoryForm) {
                inventoryForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    saveInventorySettings(formData);
                });
            }
            
            // Notification settings form
            const notificationForm = document.getElementById('notificationSettings');
            if (notificationForm) {
                notificationForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    showNotification('Notification settings updated successfully!');
                });
            }
            
            // Load user information
            try {
                loadUserInfo();
            } catch (error) {
                console.error('Error loading user info:', error);
            }
            
            console.log('Application initialized successfully');
        });

        // Create new order functionality
        function createNewOrder() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'createOrderModal';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="closeModal('createOrderModal')">&times;</span>
                    <h2>Create New Order</h2>
                    <form id="createOrderForm">
                        <div class="form-group">
                            <label class="form-label">Customer Name</label>
                            <input type="text" class="form-control" name="customer" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Order Date</label>
                            <input type="date" class="form-control" name="date" value="${new Date().toISOString().split('T')[0]}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Product</label>
                            <select class="form-control" name="product" required>
                                <option value="">Select Product</option>
                                ${dataManager.getData().products.map(product => 
                                    `<option value="${product.id}">${product.name} ($${product.price})</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-control" name="quantity" required min="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-control" name="status" required>
                                <option value="Pending">Pending</option>
                                <option value="Processing">Processing</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Create Order</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('createOrderModal')">Cancel</button>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'block';
            
            document.getElementById('createOrderForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const productId = parseInt(formData.get('product'));
                const quantity = parseInt(formData.get('quantity'));
                const data = dataManager.getData();
                const product = data.products.find(p => p.id === productId);
                
                if (product) {
                    const order = {
                        customer: formData.get('customer'),
                        date: formData.get('date'),
                        total: product.price * quantity,
                        status: formData.get('status'),
                        items: [{
                            product: product.name,
                            quantity: quantity,
                            price: product.price
                        }]
                    };
                    dataManager.addOrder(order);
                    closeModal('createOrderModal');
                    loadOrdersTable();
                    showNotification('Order created successfully!');
                }
            });
        }

        // Add user functionality
        function addUser() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'addUserModal';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="closeModal('addUserModal')">&times;</span>
                    <h2>Add New User</h2>
                    <form id="addUserForm">
                        <div class="form-group">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Role</label>
                            <select class="form-control" name="role" required>
                                <option value="">Select Role</option>
                                <option value="Owner">Owner</option>
                                <option value="Manager">Manager</option>
                                <option value="Clerk">Clerk</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-control" name="status" required>
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Add User</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addUserModal')">Cancel</button>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'block';
            
            document.getElementById('addUserForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const user = {
                    name: formData.get('name'),
                    email: formData.get('email'),
                    role: formData.get('role'),
                    status: formData.get('status')
                };
                dataManager.addUser(user);
                closeModal('addUserModal');
                loadUsersTable();
                showNotification('User added successfully!');
            });
        }

        // ML API Functions
        const ML_API_BASE = 'http://localhost:8000/api/ml';

        // Load AI insights when ML page is shown
        async function loadAIInsights() {
            try {
                // Check if user has any data first
                const dashboardResponse = await fetch(`${API_BASE_URL}/tenants/dashboard/data/`);
                const dashboardResult = await dashboardResponse.json();
                
                if (dashboardResult.success && dashboardResult.data.metrics.total_products > 0) {
                    // User has data, load AI insights
                    loadAIStatus();
                    loadModelPerformance();
                    loadProductOptions();
                } else {
                    // User has no data, show empty state
                    showEmptyAIInsights();
                }
                
            } catch (error) {
                console.error('Error loading AI insights:', error);
                showEmptyAIInsights();
            }
        }
        
        function showEmptyAIInsights() {
            // Update AI status
            document.getElementById('aiStatus').innerHTML = `
                <div class="ai-status-item">
                    <span class="status-icon">üìä</span>
                    <span class="status-text">No data available</span>
                </div>
                <div class="ai-status-item">
                    <span class="status-icon">ü§ñ</span>
                    <span class="status-text">Import your data to enable AI insights</span>
                </div>
            `;
            
            // Update model performance
            document.getElementById('modelPerformance').innerHTML = `
                <div class="performance-item">
                    <div class="performance-metric">
                        <span class="metric-label">Accuracy</span>
                        <span class="metric-value">--</span>
                    </div>
                    <div class="performance-metric">
                        <span class="metric-label">MAE</span>
                        <span class="metric-value">--</span>
                    </div>
                    <div class="performance-metric">
                        <span class="metric-label">R¬≤ Score</span>
                        <span class="metric-value">--</span>
                    </div>
                </div>
                <p class="text-muted">Import your business data to see AI model performance metrics.</p>
            `;
            
            // Update prediction section
            document.getElementById('predictionResults').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üìà</div>
                    <h4>No Predictions Available</h4>
                    <p>Import your product and sales data to get AI-powered demand predictions.</p>
                    <button class="btn btn-primary" onclick="showPage('import')">Import Data</button>
                </div>
            `;
            
            // Update optimization section
            document.getElementById('optimizationResults').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">‚ö°</div>
                    <h4>No Optimization Available</h4>
                    <p>Import your inventory data to get AI-powered optimization recommendations.</p>
                    <button class="btn btn-primary" onclick="showPage('import')">Import Data</button>
                </div>
            `;
        }

        // Load AI model status
        async function loadAIStatus() {
            try {
                console.log('Loading AI status from:', `${ML_API_BASE}/insights/`);
                const response = await fetch(`${ML_API_BASE}/insights/`);
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('AI status data:', data);
                
                if (data.success) {
                    const insights = data.insights;
                    document.getElementById('modelsLoaded').textContent = insights.models_status.loaded ? '‚úÖ Yes' : '‚ùå No';
                    document.getElementById('forecastingModels').textContent = insights.models_status.forecasting_models;
                    document.getElementById('productsOptimized').textContent = insights.models_status.optimization_rules;
                    document.getElementById('modelAccuracy').textContent = `${(insights.performance_metrics.accuracy * 100).toFixed(1)}%`;
                    
                    // Update performance metrics
                    document.getElementById('predictionAccuracy').textContent = `${(insights.performance_metrics.accuracy * 100).toFixed(1)}%`;
                    document.getElementById('costSavings').textContent = '$12.5K';
                    document.getElementById('optimizations').textContent = insights.recommendations.total_products_optimized;
                } else {
                    console.error('API returned success: false');
                    document.getElementById('modelsLoaded').textContent = '‚ùå API Error';
                }
            } catch (error) {
                console.error('Error loading AI status:', error);
                document.getElementById('modelsLoaded').textContent = '‚ùå Error';
                document.getElementById('forecastingModels').textContent = 'Error';
                document.getElementById('productsOptimized').textContent = 'Error';
                document.getElementById('modelAccuracy').textContent = 'Error';
            }
        }

        // Load model performance data
        async function loadModelPerformance() {
            try {
                console.log('Loading model performance from:', `${ML_API_BASE}/performance/`);
                const response = await fetch(`${ML_API_BASE}/performance/`);
                console.log('Performance response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Performance data:', data);
                
                if (data.success && data.performance) {
                    createModelPerformanceChart(data.performance);
                } else {
                    console.error('Performance API returned success: false or no performance data');
                }
            } catch (error) {
                console.error('Error loading model performance:', error);
            }
        }

        // Create model performance chart
        function createModelPerformanceChart(performanceData) {
            const ctx = document.getElementById('modelPerformanceChart').getContext('2d');
            
            const models = Object.keys(performanceData);
            const maeValues = models.map(model => performanceData[model].mae);
            const r2Values = models.map(model => performanceData[model].r2 * 100);
            
            chartInstances['mlPerformanceChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: models,
                    datasets: [{
                        label: 'Mean Absolute Error (MAE)',
                        data: maeValues,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }, {
                        label: 'R¬≤ Score (%)',
                        data: r2Values,
                        backgroundColor: 'rgba(118, 75, 162, 0.8)',
                        borderColor: 'rgba(118, 75, 162, 1)',
                        borderWidth: 1,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'MAE'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'R¬≤ Score (%)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }

        // Load product options for dropdowns
        function loadProductOptions() {
            // Mock product data - in real implementation, this would come from your products API
            const products = [
                { id: 'prod-1', name: 'Smartphone 1', price: 699.99, cost: 400.00 },
                { id: 'prod-2', name: 'Laptop 2', price: 1299.99, cost: 800.00 },
                { id: 'prod-3', name: 'Headphones 3', price: 199.99, cost: 80.00 },
                { id: 'prod-4', name: 'Tablet 4', price: 499.99, cost: 250.00 },
                { id: 'prod-5', name: 'Smart Watch 5', price: 299.99, cost: 120.00 }
            ];

            const productSelect = document.getElementById('productSelect');
            const optimizationSelect = document.getElementById('optimizationProductSelect');
            
            // Clear existing options
            productSelect.innerHTML = '<option value="">Select a product...</option>';
            optimizationSelect.innerHTML = '<option value="">Select a product...</option>';
            
            // Add product options
            products.forEach(product => {
                const option1 = new Option(`${product.name} ($${product.price})`, product.id);
                const option2 = new Option(`${product.name} ($${product.price})`, product.id);
                productSelect.add(option1);
                optimizationSelect.add(option2);
            });
        }

        // Predict demand for selected product
        async function predictDemand() {
            const productSelect = document.getElementById('productSelect');
            const resultDiv = document.getElementById('predictionResult');
            
            if (!productSelect.value) {
                resultDiv.innerHTML = '<div class="alert alert-warning">Please select a product first.</div>';
                return;
            }

            // Mock product data - in real implementation, get from your products API
            const productData = {
                product_id: productSelect.value,
                unit_price: 699.99,
                cost_price: 400.00,
                quantity_sold: 15,
                revenue: 10499.85,
                days_ahead: 30
            };

            try {
                resultDiv.innerHTML = '<div class="alert alert-info">üîÆ Predicting demand...</div>';
                
                const response = await fetch(`${ML_API_BASE}/predict/demand/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(productData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const prediction = data.prediction;
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h4>üéØ Demand Prediction Results</h4>
                            <p><strong>Predicted Demand:</strong> ${prediction.predicted_demand} units</p>
                            <p><strong>Confidence Level:</strong> ${(prediction.confidence * 100).toFixed(1)}%</p>
                            <p><strong>Model Used:</strong> ${prediction.model_used}</p>
                            <p><strong>Forecast Period:</strong> ${prediction.days_ahead} days</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                }
            } catch (error) {
                console.error('Error predicting demand:', error);
                resultDiv.innerHTML = '<div class="alert alert-danger">Error connecting to AI service. Please try again.</div>';
            }
        }

        // Get optimization recommendations
        async function getOptimizationRecommendations() {
            const productSelect = document.getElementById('optimizationProductSelect');
            const resultDiv = document.getElementById('optimizationResult');
            
            if (!productSelect.value) {
                resultDiv.innerHTML = '<div class="alert alert-warning">Please select a product first.</div>';
                return;
            }

            try {
                resultDiv.innerHTML = '<div class="alert alert-info">‚ö° Getting optimization recommendations...</div>';
                
                const response = await fetch(`${ML_API_BASE}/optimize/${productSelect.value}/`);
                const data = await response.json();
                
                if (data.success) {
                    const recommendations = data.recommendations;
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h4>üéØ Optimization Recommendations</h4>
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-number">${recommendations.reorder_point}</div>
                                    <div class="stat-label">Reorder Point</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number">${recommendations.reorder_quantity}</div>
                                    <div class="stat-label">Reorder Quantity</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number">${recommendations.safety_stock}</div>
                                    <div class="stat-label">Safety Stock</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number">${(recommendations.service_level * 100).toFixed(1)}%</div>
                                    <div class="stat-label">Service Level</div>
                                </div>
                            </div>
                            <p><strong>Demand Mean:</strong> ${recommendations.demand_mean} units/day</p>
                            <p><strong>Demand Std Dev:</strong> ${recommendations.demand_std} units</p>
                            <p><strong>Cost Price:</strong> $${recommendations.cost_price}</p>
                            <p><strong>Selling Price:</strong> $${recommendations.selling_price}</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                }
            } catch (error) {
                console.error('Error getting optimization recommendations:', error);
                resultDiv.innerHTML = '<div class="alert alert-danger">Error connecting to AI service. Please try again.</div>';
            }
        }


        // Load trial status and show warnings
        async function loadTrialStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/tenants/trial/status/`);
                const data = await response.json();
                
                if (data.success && data.trial_info) {
                    const trialInfo = data.trial_info;
                    
                    // Update trial banner
                    const trialBanner = document.getElementById('trial-banner');
                    const trialDays = document.getElementById('trial-days');
                    
                    if (trialInfo.is_trial && trialInfo.days_left > 0) {
                        if (trialBanner) {
                            trialBanner.style.display = 'block';
                            if (trialDays) {
                                trialDays.textContent = trialInfo.days_left;
                            }
                            
                            // Add warning classes based on days remaining
                            if (trialInfo.days_left <= 3) {
                                trialBanner.classList.add('trial-critical');
                            } else if (trialInfo.days_left <= 7) {
                                trialBanner.classList.add('trial-warning');
                            }
                        }
                    } else if (trialInfo.days_left <= 0) {
                        // Trial expired - redirect to expired page
                        window.location.href = '/tenants/trial-expired/';
                    }
                }
            } catch (error) {
                console.error('Error loading trial status:', error);
            }
        }

        // Load tenant settings and populate forms
        async function loadTenantSettings() {
            try {
                console.log('Loading tenant settings...');
                const response = await fetch(`${API_BASE_URL}/tenants/settings/get/`, {
                    credentials: 'include'
                });
                console.log('Settings response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Settings data:', data);
                
                if (data.tenant) {
                    // Populate company information
                    const companyName = document.getElementById('companyName');
                    const companyWebsite = document.getElementById('companyWebsite');
                    const companyIndustry = document.getElementById('companyIndustry');
                    const companySize = document.getElementById('companySize');
                    
                    if (companyName) companyName.value = data.tenant.name || '';
                    if (companyWebsite) companyWebsite.value = data.tenant.website || '';
                    if (companyIndustry) companyIndustry.value = data.tenant.industry || '';
                    if (companySize) companySize.value = data.tenant.company_size || '';
                    
                    console.log('Company info populated:', {
                        name: data.tenant.name,
                        website: data.tenant.website,
                        industry: data.tenant.industry,
                        company_size: data.tenant.company_size
                    });
                }
                
                if (data.user) {
                    // Populate user profile
                    const userFirstName = document.getElementById('userFirstName');
                    const userLastName = document.getElementById('userLastName');
                    const userEmail = document.getElementById('userEmail');
                    const userPhone = document.getElementById('userPhone');
                    
                    if (userFirstName) userFirstName.value = data.user.first_name || '';
                    if (userLastName) userLastName.value = data.user.last_name || '';
                    if (userEmail) userEmail.value = data.user.email || '';
                    if (userPhone) userPhone.value = data.user.phone || '';
                    
                    console.log('User profile populated:', {
                        first_name: data.user.first_name,
                        last_name: data.user.last_name,
                        email: data.user.email,
                        phone: data.user.phone
                    });
                }
                
                if (data.settings) {
                    // Populate system settings
                    const timezoneSelect = document.getElementById('timezone');
                    const currencySelect = document.getElementById('currency');
                    const lowStockInput = document.getElementById('lowStockThreshold');
                    const reorderInput = document.getElementById('defaultReorderPoint');
                    const taxInput = document.getElementById('taxRate');
                    
                    if (timezoneSelect) timezoneSelect.value = data.settings.timezone || 'America/New_York';
                    if (currencySelect) currencySelect.value = data.settings.currency || 'USD';
                    if (lowStockInput) lowStockInput.value = data.settings.low_stock_threshold || 10;
                    if (reorderInput) reorderInput.value = data.settings.default_reorder_point || 10;
                    if (taxInput) taxInput.value = data.settings.tax_rate || 0;
                }
                
                // Load users table
                await loadUsersTable();
                
            } catch (error) {
                console.error('Error loading tenant settings:', error);
                showAlert('Error loading settings. Please refresh the page.', 'error');
            }
        }

        // Change password function
        async function changePassword() {
            const form = document.getElementById('passwordChangeForm');
            const formData = new FormData(form);
            
            // Validate passwords match
            const newPassword = formData.get('new_password');
            const confirmPassword = formData.get('confirm_password');
            
            if (newPassword !== confirmPassword) {
                showAlert('New passwords do not match', 'error');
                return;
            }
            
            if (newPassword.length < 8) {
                showAlert('Password must be at least 8 characters long', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/tenants/settings/change-password/`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': getCSRFToken()
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Password changed successfully', 'success');
                    form.reset();
                } else {
                    showAlert(data.message || 'Error changing password', 'error');
                }
            } catch (error) {
                console.error('Error changing password:', error);
                showAlert('Error changing password', 'error');
            }
        }

        // Save company information
        async function saveCompanyInfo(formData) {
            try {
                const response = await fetch(`${API_BASE_URL}/tenants/settings/update-tenant/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: new URLSearchParams(formData)
                });
                
                const data = await response.json();
                if (data.success) {
                    showAlert('Company information updated successfully!', 'success');
                } else {
                    showAlert('Error updating company information: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Error saving company info:', error);
                showAlert('Error saving company information', 'error');
            }
        }

        // Save user profile
        async function saveUserProfile(formData) {
            try {
                const response = await fetch(`${API_BASE_URL}/tenants/settings/update-profile/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: new URLSearchParams(formData)
                });
                
                const data = await response.json();
                if (data.success) {
                    showAlert('Profile updated successfully!', 'success');
                } else {
                    showAlert('Error updating profile: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Error saving user profile:', error);
                showAlert('Error saving profile', 'error');
            }
        }

        // Save system settings
        async function saveInventorySettings(formData) {
            try {
                const response = await fetch(`${API_BASE_URL}/tenants/settings/update-settings/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: new URLSearchParams(formData)
                });
                
                const data = await response.json();
                if (data.success) {
                    showAlert('Inventory settings updated successfully!', 'success');
                } else {
                    showAlert('Error updating inventory settings: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Error saving inventory settings:', error);
                showAlert('Error saving inventory settings', 'error');
            }
        }

        async function saveSystemSettings(formData) {
            try {
                const response = await fetch(`${API_BASE_URL}/tenants/settings/update-settings/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: new URLSearchParams(formData)
                });
                
                const data = await response.json();
                if (data.success) {
                    showAlert('Settings updated successfully!', 'success');
                } else {
                    showAlert('Error updating settings: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Error saving system settings:', error);
                showAlert('Error saving settings', 'error');
            }
        }

        // Show alert message
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            // Insert at the top of the settings page
            const settingsPage = document.getElementById('settings');
            if (settingsPage) {
                settingsPage.insertBefore(alertDiv, settingsPage.firstChild);
                
                // Remove after 5 seconds
                setTimeout(() => {
                    alertDiv.remove();
                }, 5000);
            }
        }

        // Import Data Functions
        function downloadTemplate(templateType) {
            // Create template data directly in JavaScript to avoid authentication issues
            const templates = {
                products: {
                    headers: ['sku', 'name', 'description', 'category', 'brand', 'supplier', 'selling_price', 'cost_price', 'barcode'],
                    sampleData: [
                        ['PROD001', 'Sample Product A', 'Description for Product A', 'Electronics', 'BrandX', 'SupplierY', '19.99', '10.00', '1234567890123'],
                        ['PROD002', 'Sample Product B', 'Description for Product B', 'Clothing', 'BrandZ', 'SupplierW', '29.99', '15.00', '3210987654321'],
                        ['PROD003', 'Sample Product C', 'Description for Product C', 'Home & Garden', 'BrandA', 'SupplierB', '49.99', '25.00', '4567891234567']
                    ]
                },
                inventory: {
                    headers: ['product_sku', 'warehouse', 'quantity', 'reorder_point', 'location'],
                    sampleData: [
                        ['PROD001', 'Main Warehouse', '100', '20', 'Aisle 1, Shelf 3'],
                        ['PROD002', 'Main Warehouse', '50', '10', 'Aisle 2, Shelf 1'],
                        ['PROD003', 'Secondary Warehouse', '75', '15', 'Aisle 3, Shelf 2']
                    ]
                },
                customers: {
                    headers: ['first_name', 'last_name', 'email', 'phone', 'address'],
                    sampleData: [
                        ['John', 'Doe', 'john.doe@example.com', '555-1234', '123 Main St, Anytown, USA'],
                        ['Jane', 'Smith', 'jane.smith@example.com', '555-5678', '456 Oak Ave, Otherville, USA'],
                        ['Bob', 'Johnson', 'bob.johnson@example.com', '555-9012', '789 Pine Rd, Somewhere, USA']
                    ]
                },
                suppliers: {
                    headers: ['name', 'contact_person', 'email', 'phone', 'address'],
                    sampleData: [
                        ['Supplier A Inc', 'Alice Johnson', 'alice@supplierA.com', '111-222-3333', '789 Pine Ln, Supplier City, SC 12345'],
                        ['Global Parts Ltd', 'Bob Williams', 'bob@globalparts.com', '444-555-6666', '101 Industrial Rd, Parts Town, PT 67890'],
                        ['Quality Goods Co', 'Carol Davis', 'carol@qualitygoods.com', '777-888-9999', '555 Commerce St, Business City, BC 54321']
                    ]
                }
            };
            
            const template = templates[templateType];
            if (!template) {
                alert('Template not found');
                return;
            }
            
            // Create CSV content
            let csvContent = template.headers.join(',') + '\n';
            template.sampleData.forEach(row => {
                csvContent += row.join(',') + '\n';
            });
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${templateType}_template.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
        }

        function showHelp(helpType) {
            const helpMessages = {
                format: 'Data Format Help: Ensure your CSV files use the exact column headers from our templates. Dates should be in YYYY-MM-DD format, numbers should not include currency symbols, and text fields should not contain special characters.',
                troubleshooting: 'Troubleshooting: If your import fails, check that all required fields are filled, data types match the expected format, and there are no duplicate entries. Contact support if issues persist.',
                contact: 'Contact Support: Email us at support@inventoryflow.com or call +1 (555) 123-4567. Our team is available Monday-Friday, 9 AM - 6 PM EST.'
            };
            
            alert(helpMessages[helpType] || 'Help information not available.');
        }
        
        // Manual Entry Functions
        function showManualEntry(type) {
            const forms = document.getElementById('manualEntryForms');
            const title = document.getElementById('manualEntryTitle');
            
            // Hide all forms
            document.querySelectorAll('.manual-form').forEach(form => {
                form.style.display = 'none';
            });
            
            // Show the selected form
            const selectedForm = document.getElementById(type + 'Form');
            if (selectedForm) {
                selectedForm.style.display = 'block';
                title.textContent = `Add ${type.charAt(0).toUpperCase() + type.slice(1)}`;
                forms.style.display = 'block';
                
                // Load products for inventory form
                if (type === 'inventory') {
                    loadProductsForInventory();
                }
            }
        }
        
        function hideManualEntry() {
            document.getElementById('manualEntryForms').style.display = 'none';
        }
        
        async function loadProductsForInventory() {
            try {
                const response = await fetch(`${API_BASE_URL}/tenants/dashboard/products/`, {
                    credentials: 'include'
                });
                const result = await response.json();
                
                const select = document.getElementById('inventoryProduct');
                select.innerHTML = '<option value="">Select a product...</option>';
                
                if (result.success && result.data.length > 0) {
                    result.data.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.sku;
                        option.textContent = `${product.name} (${product.sku})`;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">No products available. Add products first.</option>';
                }
            } catch (error) {
                console.error('Error loading products:', error);
                const select = document.getElementById('inventoryProduct');
                select.innerHTML = '<option value="">Error loading products</option>';
            }
        }
        
        function setupManualEntryForms() {
            // Product form
            const productForm = document.getElementById('manualProductForm');
            if (productForm) {
                productForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await submitManualEntry('products', new FormData(this));
                });
            }
            
            // Inventory form
            const inventoryForm = document.getElementById('addInventoryForm');
            if (inventoryForm) {
                inventoryForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await submitManualEntry('inventory', new FormData(this));
                });
            }
            
            // Customer form
            const customerForm = document.getElementById('addCustomerForm');
            if (customerForm) {
                customerForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await submitManualEntry('customers', new FormData(this));
                });
            }
            
            // Supplier form
            const supplierForm = document.getElementById('addSupplierForm');
            if (supplierForm) {
                supplierForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await submitManualEntry('suppliers', new FormData(this));
                });
            }
        }
        
        async function submitManualEntry(type, formData) {
            try {
                console.log(`Submitting ${type} data...`);
                
                // Convert FormData to JSON
                const data = {};
                for (let [key, value] of formData.entries()) {
                    data[key] = value;
                }
                
                console.log('Form data:', data);
                
                // Validate required fields
                if (type === 'products') {
                    if (!data.sku || !data.name || !data.selling_price || !data.cost_price) {
                        showNotification('‚ùå Please fill in all required fields (SKU, Name, Selling Price, Cost Price)', 'error');
                        return;
                    }
                }
                
                // Get CSRF token
                const csrfToken = getCookie('csrftoken');
                console.log('CSRF Token:', csrfToken);
                
                if (!csrfToken) {
                    showNotification('‚ùå CSRF token not found. Please refresh the page and try again.', 'error');
                    return;
                }
                
                const response = await fetch(`${API_BASE_URL}/tenants/import/manual-${type}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    credentials: 'include', // Include cookies for authentication
                    body: JSON.stringify(data)
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    showNotification(`‚ùå Server error (${response.status}): ${errorText}`, 'error');
                    return;
                }
                
                const result = await response.json();
                console.log('Response result:', result);
                
                if (result.success) {
                    showNotification(`‚úÖ ${type.charAt(0).toUpperCase() + type.slice(1)} added successfully!`);
                    
                    // Clear form based on type
                    let formId;
                    switch(type) {
                        case 'products':
                            formId = 'manualProductForm';
                            break;
                        case 'inventory':
                            formId = 'addInventoryForm';
                            break;
                        case 'customers':
                            formId = 'addCustomerForm';
                            break;
                        case 'suppliers':
                            formId = 'addSupplierForm';
                            break;
                    }
                    
                    if (formId) {
                        const form = document.getElementById(formId);
                        if (form) form.reset();
                    }
                    
                    // Hide manual entry forms
                    hideManualEntry();
                    
                    // Refresh relevant tables based on type
                    if (type === 'products') {
                        loadProductsTable();
                    } else if (type === 'inventory') {
                        loadInventoryTable();
                    } else if (type === 'customers') {
                        // Refresh orders table if customers were added
                        loadOrdersTable();
                    } else if (type === 'suppliers') {
                        // Refresh products table if suppliers were added
                        loadProductsTable();
                    }
                    
                    // Refresh dashboard data if on dashboard
                    if (document.getElementById('dashboard').classList.contains('active')) {
                        loadDashboardCharts();
                    }
                } else {
                    console.error('API returned error:', result);
                    showNotification(`‚ùå Error adding ${type}: ${result.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                console.error(`Error adding ${type}:`, error);
                showNotification(`‚ùå Network error adding ${type}: ${error.message}`, 'error');
            }
        }
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        function getCSRFToken() {
            return getCookie('csrftoken');
        }

        async function uploadCSV(file, fileType) {
            try {
                console.log(`Uploading ${fileType} file:`, file.name);
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('type', fileType);

                const csrfToken = getCookie('csrftoken');
                console.log('CSRF Token for upload:', csrfToken);
                
                if (!csrfToken) {
                    throw new Error('CSRF token not found. Please refresh the page and try again.');
                }

                const response = await fetch(`${API_BASE_URL}/tenants/import/upload/`, {
                    method: 'POST',
                    body: formData,
                    credentials: 'include', // Include cookies for authentication
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                });

                console.log('Upload response status:', response.status);
                console.log('Upload response headers:', response.headers);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Upload error response:', errorText);
                    throw new Error(`Server error (${response.status}): ${errorText}`);
                }

                const result = await response.json();
                console.log('Upload result:', result);
                
                // Add fileType to result for refresh logic
                result.fileType = fileType;
                
                return result;
            } catch (error) {
                console.error('Upload error:', error);
                return { 
                    success: false, 
                    error: error.message || 'Upload failed',
                    details: error.toString(),
                    fileType: fileType
                };
            }
        }

        function updateProgress(percent, text) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            if (progressFill) progressFill.style.width = percent + '%';
            if (progressText) progressText.textContent = text;
        }

        function showResults(results) {
            const resultsDiv = document.getElementById('uploadResults');
            const contentDiv = document.getElementById('resultsContent');
            
            console.log('Showing results:', results);
            
            if (resultsDiv && contentDiv) {
                let html = '<div class="results-summary">';
                
                if (results.success) {
                    html += '<div class="success-message">‚úÖ Upload completed successfully!</div>';
                    html += `<p>Successfully imported ${results.count || 0} records.</p>`;
                    
                    if (results.message) {
                        html += `<p><strong>Message:</strong> ${results.message}</p>`;
                    }
                    
                    // Refresh relevant tables based on import type
                    setTimeout(() => {
                        if (results.fileType === 'products') {
                            loadProductsTable();
                        } else if (results.fileType === 'inventory') {
                            loadInventoryTable();
                        } else if (results.fileType === 'orders') {
                            loadOrdersTable();
                        }
                        // Also refresh dashboard to show updated metrics
                        loadDashboardCharts();
                    }, 1000);
                } else {
                    html += '<div class="error-message">‚ùå Upload failed</div>';
                    html += `<p><strong>Error:</strong> ${results.error || 'Unknown error'}</p>`;
                    
                    if (results.details) {
                        html += `<p><strong>Details:</strong> ${results.details}</p>`;
                    }
                    
                    if (results.message) {
                        html += `<p><strong>Message:</strong> ${results.message}</p>`;
                    }
                }
                
                if (results.errors && results.errors.length > 0) {
                    html += '<div class="error-details"><h5>Detailed Errors:</h5><ul>';
                    results.errors.forEach(error => {
                        html += `<li>${error}</li>`;
                    });
                    html += '</ul></div>';
                }
                
                if (results.warnings && results.warnings.length > 0) {
                    html += '<div class="warning-details"><h5>Warnings:</h5><ul>';
                    results.warnings.forEach(warning => {
                        html += `<li>${warning}</li>`;
                    });
                    html += '</ul></div>';
                }
                
                html += '</div>';
                contentDiv.innerHTML = html;
                resultsDiv.style.display = 'block';
            }
        }

        // File upload handling
        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('csvFile');
            const progressDiv = document.getElementById('uploadProgress');
            const resultsDiv = document.getElementById('uploadResults');

            // Drag and drop functionality
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                handleFiles(files);
            });

            // File input change
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });

            function handleFiles(files) {
                if (files.length === 0) return;

                // Show progress
                progressDiv.style.display = 'block';
                resultsDiv.style.display = 'none';

                let completed = 0;
                const total = files.length;

                Array.from(files).forEach((file, index) => {
                    if (!file.name.endsWith('.csv')) {
                        showResults({ success: false, error: `${file.name} is not a CSV file` });
                        return;
                    }

                    // Determine file type from filename
                    const fileName = file.name.toLowerCase();
                    let fileType = 'products'; // default
                    
                    if (fileName.includes('inventory') || fileName.includes('stock')) {
                        fileType = 'inventory';
                    } else if (fileName.includes('customer')) {
                        fileType = 'customers';
                    } else if (fileName.includes('supplier')) {
                        fileType = 'suppliers';
                    }

                    uploadCSV(file, fileType)
                        .then(result => {
                            completed++;
                            const percent = Math.round((completed / total) * 100);
                            updateProgress(percent, `Processing ${completed} of ${total} files...`);
                            
                            if (completed === total) {
                                updateProgress(100, 'Upload complete!');
                                setTimeout(() => {
                                    showResults(result);
                                    progressDiv.style.display = 'none';
                                }, 1000);
                            }
                        })
                        .catch(error => {
                            completed++;
                            showResults({ success: false, error: error.message });
                            progressDiv.style.display = 'none';
                        });
                });
            }
        }

        // Load user management data
        async function loadUserManagement() {
            try {
                const response = await fetch(`${API_BASE_URL}/tenants/dashboard/users/`);
                const result = await response.json();
                
                if (result.success) {
                    const users = result.data;
                    const tbody = document.getElementById('userTableBody');
                    
                    if (users.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No users found. This should not happen - you should be listed here.</td></tr>';
                    } else {
                        tbody.innerHTML = users.map(user => `
                            <tr>
                                <td>${user.first_name} ${user.last_name}</td>
                                <td>${user.email}</td>
                                <td><span class="badge badge-${user.role === 'owner' ? 'success' : 'info'}">${user.role}</span></td>
                                <td><span class="badge badge-${user.is_active ? 'success' : 'danger'}">${user.is_active ? 'Active' : 'Inactive'}</span></td>
                                <td>
                                    <button class="btn btn-primary" onclick="editUser('${user.email}')">Edit</button>
                                    <button class="btn btn-danger" onclick="deleteUser('${user.email}')">Delete</button>
                                </td>
                            </tr>
                        `).join('');
                    }
                } else {
                    // Show error state
                    const tbody = document.getElementById('userTableBody');
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Error loading users. Please refresh the page.</td></tr>';
                }
            } catch (error) {
                console.error('Error loading user management data:', error);
                const tbody = document.getElementById('userTableBody');
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Error loading users. Please refresh the page.</td></tr>';
            }
        }

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear any local storage
                localStorage.clear();
                sessionStorage.clear();
                
                // Redirect to signin page
                window.location.href = '/tenants/signin/';
            }
        }
    </script>
  </body>
</html>
